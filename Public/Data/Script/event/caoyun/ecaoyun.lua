--MisDescBegin

x311010_g_MissionId = 4021

x311010_g_ScriptId = 311010
--MisDescEnd
-- äîÔËÊ¹¶Ô»°UI 	0
-- ½»Ò×UI					1

--ÈÎÎñ±äÁ¿
--µÚmµt Î»´ætoÕ ðµ Ðúng(Âô)ÈÈÏútoÕ ðµ Öµ  						µÚ0Î»		Price_Up
--µÚ¶þÎ»´ætoÕ ðµ Ðúng(Âò)É±¼ÛtoÕ ðµ Öµ							µÚ1Î»		Price_Down
--µÚÈýÎ»´ætoÕ ðµ ÐúngÉíÉÏÑÎ¡¢Ìú¡¢Ã×toÕ ðµ ÊýÁ¿			µÚ2Î»   ÑÎ*100+Ìú*10+Ã×
--			µÚËÄÎ»´ætoÕ ðµ ÐúngÈÈÏútoÕ ðµ CDÉÏ´ÎÊ¹ÓÃÊ±¼ä			µÚ3Î»		
--			µÚÎåÎ»´ætoÕ ðµ ÐúngÉ±¼ÛtoÕ ðµ CDÉÏ´ÎÊ¹ÓÃÊ±¼ä			µÚ4Î»		
--µÚËÄÎ»´ætoÕ ðµ ÐúngÍæ¼Òµ±Ç°toÕ ðµ ×´Ì¬,±íÊ¾½øÐÐµ½toÕ ðµ ²½Öè,×ßµ½toÕ ðµ Á÷³Ì.		µÚ3Î»
--µÚÎåÎ»´ætoÕ ðµ ÐúngÍæ¼Òµ±Ç°toÕ ðµ ÌØÊâ×´Ì¬,Èç¸ß¼Ûäî»õµÈ				µÚ4Î»
--µÚÁùÎ»´ætoÕ ðµ Ðúng¹ÙÆ±ÉÏtoÕ ðµ Ãæ¶î  						µÚ5Î»		Balance
--µÚÆßÎ»´ætoÕ ðµ ÐúngäîÔËÊ¹toÕ ðµ TargetId,1:´ú±íLÕc Dß½ngtoÕ ðµ äîÔËÊ¹,2:´ú±íTô Châu,3´ú±íÐÕi Lý,4´ú±í¿ÉÒÔ³öÊÛäî»õtoÕ ðµ 		µÚ6Î» TransNPC
--µÚ°ËÎ»´ætoÕ ðµ Ðúng»õÉÌÉÏ´Î·¢ÉúÊÂ¼þtoÕ ðµ Ê±¼ä,mµt ¶¨toÕ ðµ Ê±¼äÄÚ,Ö»ÄÜÖ´ÐÐmµt ´Î»õÉÌtoÕ ðµ ÌØÊâÊÂ¼þ.
--
--¹ÙÆ±toÕ ðµ ÎïÆ·±àºÅ40002109
--g_CashItem={{id=40002109,num=1}}
x311010_g_CashItem_id = 40002109
x311010_g_CashItem_count = 1
x311010_g_EludeItem = {{id=20108157,num=1},{id=20108169,num=2}}
x311010_g_ChopItem = {{id=30308020,num=1} }
x311010_g_CertificateItem ={ {id=30308020,num=1} }
x311010_g_Accommodate_Distinction = {};
x311010_g_Acclimatize_Distinction = {};
x311010_g_Traverse_Region = {3,4,5,6,7,8}
--x311010_g_Title_Times_Confine = {0,100,1000,3000,7500,20000,50000}
x311010_g_Title_Times_Confine = {50000,20000,7500,3000,1000,100,0}
--x311010_g_Title_Confine 			= {124,125,126,127,128,129,130}
x311010_g_Title_Confine 			= {130,129,128,127,126,125,124}
--x311010_g_Title_Name_Confine	= {"äîÔËÉÌ","äîÔË×ß×ä","äîÔËÑº½â¹Ù","äîÔËÍ³Áì","äîÔËµ÷¶È¸±Ê¹","äîÔËµ÷¶ÈÊ¹","äîÔË×ÜÌáµ÷"}
x311010_g_Title_Name_Confine	= {"Tào v§n T±ng Ð¬ Ði«u","Tào v§n Ði«u Ðµ SÑ","Tào v§n Ði«u Ðµ Phó SÑ","Tào v§n Th¯ng Lînh","Tào v§n Áp Giäi Quan","Tào v§n T¦u T¯t","Tào v§n Doanh"}


x311010_g_Reward_Medicine_HP = {30001001,30001002,30001003,30001004,30001005,30001006,30001007,30001008,30001009,30001010}
x311010_g_Reward_Medicine_MP = {30002001,30002002,30002003,30002004,30002005,30002006,30002007,30002008,30002009,30002010}

x311010_g_Accommodate_Distinction[1] = 3530
x311010_g_Accommodate_Distinction[2] = 3531
x311010_g_Accommodate_Distinction[3] = 3532
x311010_g_Accommodate_Distinction[4] = 3533
x311010_g_Accommodate_Distinction[5] = 3534
x311010_g_Accommodate_Distinction[6] = 3535
x311010_g_Accommodate_Distinction[7] = 3536
x311010_g_Accommodate_Distinction[8] = 3537
x311010_g_Accommodate_Distinction[9] = 3538
x311010_g_Accommodate_Distinction[10] =3539
                               
x311010_g_Acclimatize_Distinction[1] = 3540
x311010_g_Acclimatize_Distinction[2] = 3541
x311010_g_Acclimatize_Distinction[3] = 3542
x311010_g_Acclimatize_Distinction[4] = 3543
x311010_g_Acclimatize_Distinction[5] = 3544
x311010_g_Acclimatize_Distinction[6] = 3545
x311010_g_Acclimatize_Distinction[7] = 3546
x311010_g_Acclimatize_Distinction[8] = 3547
x311010_g_Acclimatize_Distinction[9] = 3548
x311010_g_Acclimatize_Distinction[10] = 3549

-- add by zchw for caoyun
x311010_g_Accommodate_Distinction[11] = 33530
x311010_g_Accommodate_Distinction[12] = 33531
x311010_g_Accommodate_Distinction[13] = 33532
x311010_g_Accommodate_Distinction[14] = 33533
x311010_g_Accommodate_Distinction[15] = 33534
x311010_g_Accommodate_Distinction[16] = 33535
x311010_g_Accommodate_Distinction[17] = 33536
x311010_g_Accommodate_Distinction[18] = 33537
x311010_g_Accommodate_Distinction[19] = 33538
x311010_g_Accommodate_Distinction[20] =33539

x311010_g_Acclimatize_Distinction[11] = 33540
x311010_g_Acclimatize_Distinction[12] = 33541
x311010_g_Acclimatize_Distinction[13] = 33542
x311010_g_Acclimatize_Distinction[14] = 33543
x311010_g_Acclimatize_Distinction[15] = 33544
x311010_g_Acclimatize_Distinction[16] = 33545
x311010_g_Acclimatize_Distinction[17] = 33546
x311010_g_Acclimatize_Distinction[18] = 33547
x311010_g_Acclimatize_Distinction[19] = 33548
x311010_g_Acclimatize_Distinction[10] = 33549
x311010_g_TitleTableOfMonster = {
		{part1="Cß¾p Ti«n", part2="Hung Ð°"},
		{part1="Ðào Ngøc", part2="Ác Nhân"},
		{part1="Tr÷ng Án", part2="Cß¶ng ðÕo"},
		{part1="Giªt Ngß¶i", part2="Kë Gian"},
		{part1="Ðµc Thü", part2="Ác Gi£c"},
		{part1="Sát tâm", part2="Thích Khách"},
		{part1="Ti®t Tiêu", part2="Ác Bá"},
		}
						
x311010_g_NameTableOfMonster = {
	{part1="Tri®u", part2="Vån", part3="Bá"},
	{part1="Ti«n", part2="Nguyên", part3="Thái"},
	{part1="Tôn", part2="Thành", part3="Li®t"},
	{part1="Lý", part2="Chi", part3="Hách"},
	{part1="Châu", part2="Bá", part3="H±"},
	{part1="Ngô", part2="Tång", part3="Sáng"},
	{part1="Tr¸nh", part2="Nhân", part3="Lãng"},
	{part1="Vß½ng", part2="Ân", part3="C±"},
	}
x311010_g_Transportation_Exit = {}
x311010_g_Transportation_Exit[8] = {
	Scene_Name = "Ðôn Hoàng",
	[1] = { Exit_Name="Ðôn Hoàng ðªn LÕc Dß½ng", Exit_Reply_Number = 5, Exit_Position = {x=276,y=145} } ,
	[2] = { Exit_Name="Ðôn Hoàng ðªn Kiªm Các", Exit_Reply_Number = 6, Exit_Position = {x=230,y=270} } ,
	}
x311010_g_Transportation_Exit[7] = {
	Scene_Name = "Kiªm Các",
	[1] = { Exit_Name="Kiªm Các ðªn ÐÕi Lý", Exit_Reply_Number = 7, Exit_Position = {x=40,y=278} } ,
	[2] = { Exit_Name="Kiªm Các ðªn Ðôn Hoàng", Exit_Reply_Number = 8, Exit_Position = {x=106,y=47} } ,
	}
x311010_g_Transportation_Exit[6] = {
	Scene_Name = "Vô Lßþng S½n",
	[1] = { Exit_Name="Vô Lßþng S½n ðªn Kính H°", Exit_Reply_Number = 9, Exit_Position = {x=276,y=80} } ,
	[2] = { Exit_Name="Vô Lßþng S½n ðªn ÐÕi Lý", Exit_Reply_Number = 10, Exit_Position = {x=43,y=172} } ,
	}
x311010_g_Transportation_Exit[5] = {
	Scene_Name = "Kính H°",
	[1] = { Exit_Name="Kính H° ðªn Vô Lßþng S½n", Exit_Reply_Number = 11, Exit_Position = {x=46,y=278} } ,
	[2] = { Exit_Name="Kính H° ðªn Tô Châu",   Exit_Reply_Number = 12, Exit_Position = {x=277,y=46} } ,
	}
x311010_g_Transportation_Exit[4] = {
	Scene_Name = "Thái H° ",
	[1] = { Exit_Name="Thái H° ðªn Tung S½n",   Exit_Reply_Number = 13, Exit_Position = {x=88,y=35} } ,
	[2] = { Exit_Name="Thái Hò ðªn Tô Châu",   Exit_Reply_Number = 14, Exit_Position = {x=218,y=271} } ,
	}
x311010_g_Transportation_Exit[3] = {
	Scene_Name = "Tung S½n",
	[1] = { Exit_Name="Tung S½n ðªn LÕc Dß½ng",   Exit_Reply_Number = 15, Exit_Position = {x=42,y=54} } ,
	[2] = { Exit_Name="Tung S½n ðªn Thái H°",   Exit_Reply_Number = 16, Exit_Position = {x=281,y=25} } ,
	}
	
x311010_g_Transportation_City = {}
x311010_g_Transportation_City[0] = {
	Scene_Name = "LÕc Dß½ng",
	Reply_Number = 17,
	[0] = {x=160,y=278},
	[1] = {x=282,y=133},
	[2] = {x=37,y=134},
}
x311010_g_Transportation_City[1] = {
	Scene_Name = "Tô Châu",
	Reply_Number = 18,
	[0] = {x=182,y=265},
	[1] = {x=64,y=163},
	[2] = {x=183,y=53},
}
x311010_g_Transportation_City[2] = {
	Scene_Name = "ÐÕi Lý",
	Reply_Number = 19,
	[0] = {x=160,y=277},
	[1] = {x=280,y=152},
	[2] = {x=39,y=152},
}

x311010_g_Transportation_Legate = {}
x311010_g_Transportation_Legate[0] = {
	Scene_Name = "LÕc Dß½ng",
	Reply_Number = 20,
	Position = {x=222,y=179},
}

x311010_g_Transportation_Legate[1] = {
	Scene_Name = "Tô Châu",
	Reply_Number = 21,
	Position = {x=234,y=86},
}

x311010_g_Transportation_Legate[2] = {
	Scene_Name = "ÐÕi Lý",
	Reply_Number = 22,
	Position = {x=54,y=185},
}

x311010_g_SpecialImpact = {}
x311010_g_SpecialImpact[23] = {
	Impact_Name = "gia tång ngoÕi công",
	Impact_ID = {115,116,117,118,119,30115,30116,30117,30118,30119},
	}

x311010_g_SpecialImpact[24] = {
	Impact_Name = "gia tång ngoÕi thü",
	Impact_ID = {120,121,122,123,124,30120,30121,30122,30123,30124},
	}
	
x311010_g_SpecialImpact[25] = {
	Impact_Name = "gia tång nµi công",
	Impact_ID = {125,126,127,128,129,30125,30126,30127,30128,30129},
	}
	
x311010_g_SpecialImpact[26] = {
	Impact_Name = "gia tång nµi thü",
	Impact_ID = {130,131,132,133,134,30130,30131,30132,30133,30134},
	}
x311010_g_IncreaseSpeed_Impact = {}
x311010_g_IncreaseSpeed_Impact[27] = {
	Impact_ID = 135,
	}

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x311010_OnDefaultEvent( sceneId, selfId, BagIndex )	-- ði¬m»÷¸ÃÈÎÎñºóÖ´ÐÐ´Ë½Å±¾
	--Í¶»úÈ¡ÇÉtoÕ ðµ ·½·¨,Ö»´Ëmµt ´Î,ÎðÍÆ¹ã.

  local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
--	SetMissionByIndex(sceneId,selfId,misIndex,6,-1)
	SetMissionByIndex(sceneId,selfId,misIndex,3,0)
	
	local New_Time = LuaFnGetCurrentTime()
	local HaggleUp = 600 - New_Time + GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINUP)
	local HaggleDown = 900 - New_Time + GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINDOWN)
	local	circle	 = GetMissionData(sceneId,selfId,MD_CAOYUN_HUAN)
	
	if(HaggleUp <0 ) then
		HaggleUp = 0
	end

	if(HaggleDown <0 ) then
		HaggleDown = 0
	end
	--begin modified by zhangguoxin 090207
	--local iDayCount=GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT)
	--local iTime = mod(iDayCount,100000)
	--local iDayTime = floor(iTime/100)	--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(ÌìÊý)
	--local iQuarterTime = mod(iTime,100)	--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(¿Ì)
	--local iDayHuan = floor(iDayCount/100000) --µ±ÌìÄÚÍê³ÉtoÕ ðµ S¯ l¥n nhi®m vø 
	iDayHuan = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT);
	--end  modified by zhangguoxin 090207
	
	local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
	Quotiety = 1
	local Price_Sell = 15000 * Quotiety

	BeginUICommand(sceneId)
		UICommand_AddInt(sceneId,5)
		UICommand_AddInt(sceneId,12)
		UICommand_AddInt(sceneId,HaggleUp)
		UICommand_AddInt(sceneId,HaggleDown)
		UICommand_AddInt(sceneId,circle)
		UICommand_AddInt(sceneId,misIndex)
		UICommand_AddInt(sceneId,iDayHuan)
		UICommand_AddInt(sceneId,Price_Sell)
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 0)
	
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x311010_OnEnumerate( sceneId, selfId, targetId )
--Èç¹ûÍæ¼ÒÍê³É¹ýCái này ÈÎÎñ

	  if IsMissionHaveDone(sceneId,selfId,x311010_g_MissionId) > 0 then
	   	return 
		end

    --Èç¹ûÒÑ½Ó´ËÈÎÎñ
    if IsHaveMission(sceneId,selfId,x311010_g_MissionId) > 0 then

			local TransNPC = x311010_TransPortNPC(sceneId,targetId)
			
			if TransNPC == -1 then
				return
			end
			
			if TransNPC == 4 then
			
				local ItemNum = GetItemCount(sceneId,selfId,x311010_g_CashItem_id)
				if ItemNum < x311010_g_CashItem_count then
					BeginUICommand(sceneId)
						UICommand_AddInt(sceneId,5)
						UICommand_AddInt(sceneId,6)
					EndUICommand(sceneId)
					DispatchUICommand(sceneId,selfId, 0)
					return
				end
				
				if targetId == GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID) then
				-----------------------------------------------------------------
					local msg = "Xin l²i, ta ðã phøc vø các hÕ r°i"
			 		local cmsg = "R¶i khöi"
					x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg,0)
					return
				end

				if TRAFFICKER_CLICK_TIMES >= 30 then
					local msg = "Hôm nay ta r¤t m®t, không mu¯n phøc vø thêm ai næa cä. Hy v÷ng s¨ ðßþc giúp ðÞ các hÕ l¥n sau"
			 		local cmsg = "Th§t không may.."
					x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg,0)
					return
				end

				SetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID,targetId)
				local  PlayerSex=GetSex(sceneId,selfId)
				if PlayerSex == 0 then
					PlayerSex = "Næ hi®p"
				else
					PlayerSex = "ÐÕi hi®p"
				end
				
				BeginEvent(sceneId)
		
					AddText(sceneId,PlayerSex.."Ta là mµt H¡c th¸ thß½ng nhân n±i tiªng, g£p ðßþc ta xem nhß là duyên s¯ cüa các hÕ. Ðúng d¸p hôm nay ta r¤t vui, có th¬ phøc vø ðßþc các hÕ, có mu¯n thØ v§n may cüa mình không?")
					AddNumText(sceneId,x311010_g_ScriptId,"Ta mu¯n thØ v§n may",-1,28)
					AddNumText(sceneId,x311010_g_ScriptId,"Hay là thôi ði..",-1,0)
				EndEvent(sceneId)
				DispatchEventList(sceneId,selfId,targetId)

				return
			
			end
			
			local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
			SetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID,targetId)
			SetMissionByIndex(sceneId,selfId,misIndex,0,0)
			SetMissionByIndex(sceneId,selfId,misIndex,1,0)
			
			local Caoyun_Times =  GetMissionData(sceneId,selfId,MD_CAOYUN_SUMTIME)	
			local find = -1
			local msg,cmsg
			for i, times in x311010_g_Title_Times_Confine do
				if times <= Caoyun_Times then
					find = i
					break
				end
			end
--ÆÁ±Î³ÆºÅ²¿·Ö
--			find = -1
--Ôö¼Ómµt cái²éÑ¯Íæ¼ÒÐúng·ñÐã ðÕt ðßþc ¸Ã³ÆºÅtoÕ ðµ ½Ó¿Ú,ËïÓê
			local New_Title = x311010_g_Title_Confine[find]
--			PrintNum(GetTitle( sceneId, selfId,5 ))
--			PrintNum(New_Title)
			if GetTitle( sceneId, selfId,5 ) ~= New_Title and find >= 0 then
				LuaFnAwardTitle( sceneId, selfId,  5, New_Title)
				SetCurTitle(sceneId, selfId,  5, New_Title)
				LuaFnDispatchAllTitle(sceneId, selfId)
				if Caoyun_Times < 20000 then
					if Caoyun_Times == x311010_g_Title_Times_Confine[find] then
						msg = "Chúc m×ng các hÕ ðÕt ðßþc "..x311010_g_Title_Name_Confine[find].."Cách g÷i cüa..., hy v÷ng các hÕ có th¬ tiªp tøc c¯ng hiªn cho Tào v§n"
		 				cmsg = "Cám ½n.."
		 				x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg,2)
						return
		 			end
				else
					if Caoyun_Times == x311010_g_Title_Times_Confine[find] then
						msg = "Vì các hÕ ðã có nhi«u c¯ng hiªn ð£c bi®t cho Tào v§n, tri«u ðình ðã nh¶ ta chuy¬n l¶i ðªn các hÕ r¢ng các hÕ ðã ðßþc phong làm.."..x311010_g_Title_Name_Confine[find].."Hy v÷ng l¥n sau các hÕ có th¬ dìu d¡t ti¬u nhân"
		 				cmsg = ", biªt r°i"
	 					x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg,2)
						return
					end
				end
							
			end
			--client ÒªTÕi UI ÉÏÏÔÊ¾"ÂòÂôäî»õ"ºÍ"¶mµt »¹ÙÆ±"Õâ2cáibutton
			--²¢ÇÒ°ÑNPCtoÕ ðµ ID´«¸øclient,ÒÔ±¸ÏÂmµt ²½µ÷ÓÃ.
			
			BeginUICommand(sceneId)
				UICommand_AddInt(sceneId,3)
				UICommand_AddInt(sceneId,targetId)
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 0)

    --Thöa mãnÈÎÎñ½ÓÊÕÌõ¼þ

    elseif 1 > 0 then
	    local TransNPC = x311010_TransPortNPC(sceneId,targetId)

			if TransNPC == 4 then
				BeginUICommand(sceneId)
					UICommand_AddInt(sceneId,5)
					UICommand_AddInt(sceneId,10)
				EndUICommand(sceneId)
				DispatchUICommand(sceneId,selfId, 0)
				return
			end

			--client ÒªTÕi UI ÉÏÏÔÊ¾" ðÕt ðßþc¹ÙÆ±"Cái này button
			--²¢ÇÒ°ÑNPCtoÕ ðµ ID´«¸øclient,ÒÔ±¸ÏÂmµt ²½µ÷ÓÃ.
			BeginUICommand(sceneId)
				UICommand_AddInt(sceneId,4)
				UICommand_AddInt(sceneId,targetId)
				UICommand_AddInt(sceneId,TransNPC)
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 0)
			SetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID,targetId)
--			PrintStr("target  Id="..targetId)

    end
end 


--**********************************
--¼ì²âTiªp thøÌõ¼þ
--**********************************
function x311010_CheckAccept( sceneId, selfId )
	--C¥n 1c¤p²ÅÄÜ½Ó
	local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
	Quotiety = 2
	local Corpus = 10000 * Quotiety
	if IsTeamFollow( sceneId, selfId ) == 1 then
		BeginEvent(sceneId)
			strText = format("Các hÕ ðang · trong tình trÕng b¸ quân ðµi giám sát, không th¬ nh§n nhi®m vø")
			AddText(sceneId,strText)
 		EndEvent(sceneId)
 		DispatchMissionTips(sceneId,selfId)
		return 0
	elseif GetLevel( sceneId, selfId ) < 40 then

		local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
		local msg = "c¤p b§c cüa các hÕ vçn chßa ðªn 40, hãy ðþi ðªn khi ðÕt ðßþc c¤p 40 r°i hÆn ðªn tìm ta nhé"
 		local cmsg = "Ta s¨ lên c¤p 40 nhanh thôi"
		x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg,0)

		return 0
--ÒÔºó²ß»®¸ÄÖ÷ÒâÁË¾Í°ÑÕâ¶Î´ò¿ª.
	elseif GetMoney(sceneId,selfId)+GetMoneyJZ(sceneId, selfId) < Corpus then
		BeginEvent(sceneId)
			AddText(sceneId,"Các hÕ không ðü ngân lßþng.");
			EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return 0
	elseif x311010_OnAccept_Necessary(sceneId,selfId) < 0 then
		return 0
	end

	return 1

end

function x311010_Calculate_Modulus( sceneId, selfId )
	if GetLevel( sceneId, selfId ) >= 70 then
		return 3
	elseif GetLevel( sceneId, selfId ) >= 50 then
		return 2
	elseif GetLevel( sceneId, selfId ) >= 35 then
		return 2
	elseif GetLevel( sceneId, selfId ) >= 15 then
		return 1
	end
	return 1
end

function x311010_Calculate_Double( sceneId, selfId )

	local ret = 1

	local Orientation_Article = 1
	local Article_Quantity
	for i, item in x311010_g_CertificateItem do
		Article_Quantity = GetItemCount( sceneId, selfId, item.id )
		if Article_Quantity < item.num then
			Orientation_Article = 0
		end
	end
	
	if Orientation_Article == 1 then
		local HaveChop = DelItem( sceneId, selfId, x311010_g_CertificateItem[1].id, x311010_g_CertificateItem[1].num )
		if HaveChop > 0 then
			ret = ret * 2
		end
	end

	return ret
end

function x311010_Calculate_Calender( sceneId, selfId )
	local ret = 1

	local nWeek = GetTodayWeek()
	if (nWeek==0) == 1  then
		ret = ret * 2
		Msg2Player( sceneId,selfId,"Vì hôm nay là ngày v§n chuy¬n, do ðó l¥n bán ra này cüa các hÕ thu nh§p tång g¤p bµi.",MSG2PLAYER_PARA)
		BeginEvent(sceneId)
			AddText(sceneId,"Vì hôm nay là ngày v§n chuy¬n, do ðó l¥n bán ra này cüa các hÕ thu nh§p tång g¤p bµi.");
		EndEvent(sceneId)
		DispatchMissionTips(sceneId, selfId)
	end

	return ret
end

function x311010_Calculate_Margin( sceneId, selfId, now_balance )

	local Level = GetLevel( sceneId, selfId )
	local new_balance = (now_balance-10000) * (0.625+0.02*(Level-30)/2) + 10000
	
	return new_balance
	
end

function x311010_OnHaggleUp( sceneId, selfId )	-- ði¬m»÷¸ÃÈÎÎñ"ÈÈÏú"ºóÖ´ÐÐ´Ë½Å±¾

--ÅÐ¶ÏËûÐúng·ñ¿ÉÈÈÏú
--±ÈÈçÊ±¼ätoÕ ðµ ÅÐ¶Ï,ÅÐ¶ÏÕâ´ÎºÍÉÏ´ÎÖ®¼äÊ±¼ätoÕ ðµ ²î¾à
--should add some code

--È¡ÈÎÎñ±äÁ¿toÕ ðµ Öµ
	local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
	Price_Up = GetMissionParam(sceneId,selfId,misIndex,0)
	Pre_Time = GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINUP)
--	targetId = GetMissionParam(sceneId,selfId,misIndex,6)
	local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
	TransNpc =x311010_TransPortNPC(sceneId,targetId)
	
	local Now_Time = LuaFnGetCurrentTime();
--µ±Ç°Ê±¼äÔõÃ´È¡?
	if Now_Time - Pre_Time < 10*60 then
			BeginUICommand(sceneId)
				UICommand_AddInt(sceneId,5)
				UICommand_AddInt(sceneId,9)
				UICommand_AddInt(sceneId,Pre_Time + 10*60 - Now_Time)
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 0)
			return
			
	end
	if TransNpc <= 0 then
		return
	end

--¾­¼ÆËã¸Ä±ä´ËPrice_Up
--****
--should add some code

--ÈÈÏúºó¼Û¸ñ±äÎª18000
	local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
	Quotiety = 1
	Price_Up = 18000 * Quotiety
	Price_Up = x311010_Calculate_Margin( sceneId, selfId, Price_Up )
	--ÉèÖÃ³ÉÐÂtoÕ ðµ Öµ

	SetMissionByIndex(sceneId,selfId,misIndex,0,Price_Up)	

--»¹C¥n ´æ´¢ÕâÊ±toÕ ðµ Ê±¼ä
--µ±Ç°Ê±¼äÔõÃ´È¡?
	local New_Time = LuaFnGetCurrentTime();
--	SetMissionByIndex(sceneId,selfId,misIndex,3,New_Time)	
	SetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINUP,New_Time)

	BeginEvent(sceneId)
		strText = "Tiêu thø thành công, giá sän ph¦m tång lên mÑc #{_EXCHG"..Price_Up.."}"			
		AddText(sceneId,strText);
	EndEvent(sceneId)
	DispatchMissionTips(sceneId,selfId)
	
	BeginUICommand(sceneId)
			UICommand_AddInt(sceneId,4)
--ÈÈÏúºó¼Û¸ñ±äÎªPrice_Up
			UICommand_AddInt(sceneId,misIndex)
--´ËÊ±ÈÈÏútoÕ ðµ ÀäÈ´Ê±¼ä±äÎª10 phút,²¢¸æÖªclient
	
--µÚ2Î»±íÊ¾µ±Ç°»¹Ê£toÕ ðµ PriceUpÊ±¼ä
			Pre_Time = GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINUP)
			Now_Time = LuaFnGetCurrentTime();
			if Now_Time - Pre_Time < 10*60 then
				UICommand_AddInt(sceneId,Pre_Time + 10*60 - Now_Time)
			else
				UICommand_AddInt(sceneId,0)
			end
			--µÚ3Î»±íÊ¾µ±Ç°»¹Ê£toÕ ðµ PriceDownÊ±¼ä
			Pre_Time = GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINDOWN)
			if Now_Time - Pre_Time < 15*60 then
				UICommand_AddInt(sceneId,Pre_Time + 15*60 - Now_Time)
			else
				UICommand_AddInt(sceneId,0)
			end
			UICommand_AddInt(sceneId,TransNpc)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 1)
end


function x311010_OnHaggleDown( sceneId, selfId )	-- ði¬m»÷¸ÃÈÎÎñ"É±¼Û"ºóÖ´ÐÐ´Ë½Å±¾

--ÅÐ¶ÏËûÐúng·ñ¿ÉÉ±¼Û
--±ÈÈçÊ±¼ätoÕ ðµ ÅÐ¶Ï,ÅÐ¶ÏÕâ´ÎºÍÉÏ´ÎÖ®¼äÊ±¼ätoÕ ðµ ²î¾à
--È¡ÈÎÎñ±äÁ¿toÕ ðµ Öµ
	local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
	Price_Down = GetMissionParam(sceneId,selfId,misIndex,1)
	Pre_Time = GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINDOWN)
--	targetId = GetMissionParam(sceneId,selfId,misIndex,6)
	local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
	
	TransNpc =x311010_TransPortNPC(sceneId,targetId)
	

--µ±Ç°Ê±¼äÔõÃ´È¡?
	Now_Time = LuaFnGetCurrentTime();
	if Now_Time - Pre_Time < 15*60 then

			BeginUICommand(sceneId)
				UICommand_AddInt(sceneId,5)
				UICommand_AddInt(sceneId,9)
				UICommand_AddInt(sceneId,Pre_Time + 15*60 - Now_Time)
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 0)
			return
			
	end
	
	if TransNpc <= 0 then
		return
	end

--¾­¼ÆËã¸Ä±ä´ËPrice_Up
--*****


--É±¼Ûºó¼Û¸ñ±äÎªX000
	local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
	Quotiety = 1
	Price_Down = 8000 * Quotiety
--ÉèÖÃ³ÉÐÂtoÕ ðµ Öµ

	SetMissionByIndex(sceneId,selfId,misIndex,1,Price_Down)

	
--»¹C¥n ´æ´¢ÕâÊ±toÕ ðµ Ê±¼ä
--µ±Ç°Ê±¼äÔõÃ´È¡?
	local New_Time = LuaFnGetCurrentTime();
--	SetMissionByIndex(sceneId,selfId,misIndex,4,New_Time)	
	SetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINDOWN,New_Time)

	BeginEvent(sceneId)
		strText = "Trä giá thành công, giá sän ph¦m xu¯ng mÑc #{_EXCHG"..Price_Down.."}"			
		AddText(sceneId,strText);
	EndEvent(sceneId)
	DispatchMissionTips(sceneId,selfId)

	BeginUICommand(sceneId)
			UICommand_AddInt(sceneId,5)
--É±¼Ûºó¼Û¸ñ±äÎªPrice_Down
			UICommand_AddInt(sceneId,misIndex)
--			UICommand_AddInt(sceneId,15*60)
--´ËÊ±É±¼ÛtoÕ ðµ ÀäÈ´Ê±¼ä±äÎª15 phút,²¢¸æÖªclient
--µÚ2Î»±íÊ¾µ±Ç°»¹Ê£toÕ ðµ PriceUpÊ±¼ä
		Pre_Time =  GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINUP)
		Now_Time = LuaFnGetCurrentTime();
		if Now_Time - Pre_Time < 10*60 then
			UICommand_AddInt(sceneId,Pre_Time + 10*60 - Now_Time)
		else
			UICommand_AddInt(sceneId,0)
		end
--µÚ3Î»±íÊ¾µ±Ç°»¹Ê£toÕ ðµ PriceDownÊ±¼ä
		Pre_Time =  GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINDOWN)
		if Now_Time - Pre_Time < 15*60 then
			UICommand_AddInt(sceneId,Pre_Time + 15*60 - Now_Time)
		else
			UICommand_AddInt(sceneId,0)
		end
		UICommand_AddInt(sceneId,TransNpc)
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 1)

end

--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x311010_OnKillObject( sceneId, selfId, objdataId, objId )
	local monsterName = GetMonsterNamebyDataId(objdataId)
	if monsterName=="Tào v§n ti¬u quái" or monsterName=="Tào v§n ðÕi quái"   then
		-- µôÊé
		if random(1000) < 25 then
			AddMonsterDropItem( sceneId, objId, selfId, 30501035 )
		end
		-- ¸øBUFF
		if random(1000) < 25 then
			LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,135,0)
		end
	end
end

--**********************************
--½øÈëÇøÓòÊÂ¼þ
--**********************************
function x311010_OnEnterArea( sceneId, selfId, zoneId )
end

--**********************************
--µÀ¾ß¸Ä±ä
--**********************************
function x311010_OnItemChanged( sceneId, selfId, itemdataId )
end

--**********************************
--½ÓCái này ÈÎÎñ
--Ò²¾ÍÐúng ði¬mÁË¡° ðÕt ðßþc¹ÙÆ±¡±
--**********************************
function x311010_OnAcceptMission( sceneId, selfId )

  --Èç¹ûÒÑ½Ó´ËÈÎÎñ
  if IsHaveMission(sceneId,selfId,x311010_g_MissionId) > 0 then
  		return
  end
  
  local strText = "";
  --½ðÇ®Ðúng·ñ¹» ÓÅÏÈ¿Û³ý½»×Ó zchw
  --½ðÇ®Ðúng·ñ¹»
  local HumanMoney = LuaFnGetMoney( sceneId, selfId )
  local HumanMoneyJZ = GetMoneyJZ( sceneId, selfId );
  
  local checkmoney = 20000
  if HumanMoney + HumanMoneyJZ  <  checkmoney then
  		BeginEvent(sceneId)
			AddText(sceneId,"Không ðü ngân lßþng.");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
			return 0
  end
  
  --Ðúng·ñTÕi äîÔË
	local haveImpact = LuaFnHaveImpactOfSpecificDataIndex(sceneId, selfId, 113)
	if haveImpact == 1 then
		BeginEvent(sceneId)
			strText = "Xin l²i, các hÕ ðang · trÕng thái v§n chuy¬n không th¬ nh§n ngân phiªu."
			AddText(sceneId,strText);
		EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return
	end
	local ItemNum = GetItemCount(sceneId,selfId,x311010_g_CashItem_id)
	local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
	Quotiety = 2
	local Corpus = 10000 * Quotiety
	
	--begin modified by zhangguoxin 090207
	--local iDayCount = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT)/100000
	local iDayCount = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT);
	--end modified by zhangguoxin 090207
	
	if ItemNum >= x311010_g_CashItem_count then
		if x311010_OnAccept_Necessary( sceneId, selfId ) <= 0 then
			return 0
		end
		local ret = AddMission( sceneId,selfId, x311010_g_MissionId, x311010_g_ScriptId, 0, 0, 0 )
		
		if ret < 1  then
--			BeginEvent(sceneId)
--				strText = "#YCüa ngß½i ÈÎÎñÈÕÖ¾ÒÑ¾­ÂúÁË,ÎÞ·¨½øÐÐäîÔË."
--				AddText(sceneId,strText);
--			EndEvent(sceneId)
--			DispatchMissionTips(sceneId,selfId)
			return
		end
		
		local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)			-- ði¬mµ½ÈÎÎñtoÕ ðµ ÐòÁÐºÅ
		SetMissionByIndex(sceneId,selfId,misIndex,0,0)						--¸ù¾ÝÐòÁÐºÅ°ÑÈÎÎñ±äÁ¿toÕ ðµ µÚ0Î»ÖÃ0 (ÈÎÎñÍê³ÉÇé¿ö)
		SetMissionByIndex(sceneId,selfId,misIndex,1,0)
		SetMissionByIndex(sceneId,selfId,misIndex,2,0)
		SetMissionByIndex(sceneId,selfId,misIndex,3,0)
		SetMissionByIndex(sceneId,selfId,misIndex,4,0)
		
		--¼ÆËãµ½µ×¸Ã¸øËû¶àÉÙÇ®
		--ÒÔºó²ß»®¸ÄÖ÷ÒâÁË¾Í°ÑÕâ¶Î´ò¿ª
		--ÓÅÏÈ¿Û³ý½»×Ó zchw
		
		local nDelJZ, nDelMoney = LuaFnCostMoneyWithPriority(sceneId, selfId, 20000);
		if (nDelJZ == -1) then
			BeginEvent(sceneId)
			AddText(sceneId,"Các hÕ ðã thª ch¤p #{_EXCHG"..Corpus.."}, l¤y ðßþc mµt t¶ quan phiªu Tào v§n");  
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
			return 0;
		end
		
		if (nDelMoney <= 0) then
			BeginEvent(sceneId)
				AddText(sceneId,"Các hÕ ðã thª ch¤p #{_EXCHG"..nDelJZ.."}, l¤y ðßþc mµt t¶ quan phiªu Tào v§n");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
		elseif (nDelJZ <= 0) then
			BeginEvent(sceneId)
				AddText(sceneId,"Các hÕ ðã thª ch¤p #{_MONEY"..nDelMoney.."}, l¤y ðßþc mµt t¶ quan phiªu Tào v§n" );
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
		else
			BeginEvent(sceneId)
					AddText(sceneId,"Các hÕ ðã thª ch¤p #{_EXCHG"..nDelJZ.."}");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
			BeginEvent(sceneId)
				AddText(sceneId,"Các hÕ ðã thª ch¤p #{_MONEY"..nDelMoney.."}, l¤y ðßþc mµt t¶ quan phiªu Tào v§n");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
		end
		
		--Í³¼ÆÊý¾Ý¼ÇÂ¼
		LuaFnAuditCaoYun(sceneId, selfId, iDayCount, 1, Corpus)

		SetMissionByIndex(sceneId,selfId,misIndex,5,Corpus)
		SetMissionByIndex(sceneId,selfId,misIndex,6,0)
		SetMissionByIndex(sceneId,selfId,misIndex,7,0)
		--²¢ÇÒÔö¼Ómµt cái³ÆºÅ¡°äîÔËÉÌ¡± ËïÓê
--		LuaFnAwardTitle( sceneId, selfId,  5, 124)
--		SetCurTitle(sceneId, selfId,  5, 124)
--		LuaFnDispatchAllTitle(sceneId, selfId)
		LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,113,0)
		if ret > 0 then
--			AddItemListToHuman(sceneId,selfId)
			BeginUICommand(sceneId)
				UICommand_AddInt(sceneId,5)
				UICommand_AddInt(sceneId,2)
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 0)
		end
	elseif x311010_CheckAccept(sceneId,selfId) > 0 then

		local ret = AddMission( sceneId,selfId, x311010_g_MissionId, x311010_g_ScriptId, 0, 0, 0 )

		if ret < 1  then
			return
		end
		
		ret = TryRecieveItem( sceneId, selfId, x311010_g_CashItem_id, QUALITY_MUST_BE_CHANGE)
		if ret > 0 then 	

			local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)			-- ði¬mµ½ÈÎÎñtoÕ ðµ ÐòÁÐºÅ
			SetMissionByIndex(sceneId,selfId,misIndex,0,0)						--¸ù¾ÝÐòÁÐºÅ°ÑÈÎÎñ±äÁ¿toÕ ðµ µÚ0Î»ÖÃ0 (ÈÎÎñÍê³ÉÇé¿ö)
			SetMissionByIndex(sceneId,selfId,misIndex,1,0)
			SetMissionByIndex(sceneId,selfId,misIndex,2,0)
			SetMissionByIndex(sceneId,selfId,misIndex,3,0)
			SetMissionByIndex(sceneId,selfId,misIndex,4,0)

			-- Íæ¼Ò¹ØÐÄÉ±¹Ö
			SetMissionEvent( sceneId,selfId,x311010_g_MissionId, 0 )

			--¼ÆËãµ½µ×¸Ã¸øËû¶àÉÙÇ®
			--ÒÔºó²ß»®¸ÄÖ÷ÒâÁË¾Í°ÑÕâ¶Î´ò¿ª
			--ÓÅÏÈ¿Û³ý½»×Ó zchw
	
			local nDelJZ, nDelMoney = LuaFnCostMoneyWithPriority(sceneId, selfId, 20000);
			if (nDelJZ == -1) then
				BeginEvent(sceneId)
				AddText(sceneId,"Các hÕ ðã thª ch¤p #{_EXCHG"..Corpus.."}, l¤y ðßþc mµt t¶ quan phiªu Tào v§n");  
				EndEvent(sceneId)
				DispatchMissionTips(sceneId,selfId)
				return 0;
			end
			
			if (nDelMoney <= 0) then
				BeginEvent(sceneId)
					AddText(sceneId,"Các hÕ ðã thª ch¤p #{_EXCHG"..nDelJZ.."}, l¤y ðßþc mµt t¶ quan phiªu Tào v§n");
				EndEvent(sceneId)
				DispatchMissionTips(sceneId,selfId)
			elseif (nDelJZ <= 0) then
				BeginEvent(sceneId)
					AddText(sceneId,"Các hÕ ðã thª ch¤p #{_MONEY"..nDelMoney.."}, l¤y ðßþc mµt t¶ quan phiªu Tào v§n" );
				EndEvent(sceneId)
				DispatchMissionTips(sceneId,selfId)
			else
				BeginEvent(sceneId)
					AddText(sceneId,"Các hÕ ðã thª ch¤p #{_EXCHG"..nDelJZ.."}");
				EndEvent(sceneId)
				DispatchMissionTips(sceneId,selfId)
				BeginEvent(sceneId)
					AddText(sceneId,"Các hÕ ðã thª ch¤p #{_MONEY"..nDelMoney.."}, l¤y ðßþc mµt t¶ quan phiªu Tào v§n");
				EndEvent(sceneId)
				DispatchMissionTips(sceneId,selfId)
			end

			--Í³¼ÆÊý¾Ý¼ÇÂ¼
			LuaFnAuditCaoYun(sceneId, selfId, iDayCount, 1, Corpus)

			LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,113,0)
			SetMissionByIndex(sceneId,selfId,misIndex,5,Corpus)
			SetMissionByIndex(sceneId,selfId,misIndex,6,0)
			SetMissionByIndex(sceneId,selfId,misIndex,7,0)
			
--²¢ÇÒÔö¼Ómµt cái³ÆºÅ¡°äîÔËÉÌ¡± ËïÓê
--			LuaFnAwardTitle( sceneId, selfId,  5, 124)
--			SetCurTitle(sceneId, selfId,  5, 124)
--			LuaFnDispatchAllTitle(sceneId, selfId)


			local Caoyun_Times =  GetMissionData(sceneId,selfId,MD_CAOYUN_SUMTIME)	
--			PrintStr("times="..Caoyun_Times)

			if Caoyun_Times == 0 then
				
				local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
				local msg = "Xem ra ðây là l¥n ð¥u tiên các hÕ tham gia Tào v§n, Tào v§n quä thñc là mµt mµt ngành ngh« có th¬ thu ðßþc lþi nhu§n r¤t l¾n, theo c¤p ðµ thång tiªn, hàng ngày không nhæng có th¬ gia tång s¯ lßþng Tào v§n mà còn có th¬ gia tång lþi nhu§n thu ðßþc trong m²i l¥n Tào v§n"
				local msg2 = "Nhßng mà Tào v§n không phÑc tÕp nhß các hÕ tß·ng tßþng ðâu, chï c¥n nh¤n vào nút l¤y quan phiªu trên màn hình thì ðã có th¬ mua hàng hóa Tào v§n r°i, sau ðó ðem nhæng hàng hóa ð¯i Ñng ðªn thành ph¯ có sØ døng Tào v§n khÁc Bán ra là ðßþc"
				local msg3 = "Nh¾ là trong khi Tào v§n thì không ðßþc sØ døng ngß¶i chuy¬n hàng cüa trÕm d¸ch hay cüa môn phái ð¬ v§n chuy¬n hàng"
 				local cmsg = "Cám ½n giäi thích cüa các hÕ.."
				BeginEvent(sceneId)

					AddText(sceneId,msg)
					AddText(sceneId,msg2)
					AddText(sceneId,msg3)
					AddNumText(sceneId,x311010_g_ScriptId,cmsg,-1,1)

				EndEvent(sceneId)
				DispatchEventList(sceneId,selfId,targetId)
--				x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 1)
--µÚmµt ´ÎÊ±¸øÓèäîÔËÉÌtoÕ ðµ ³ÆºÅ
				LuaFnAwardTitle( sceneId, selfId,  5, 124)
				SetCurTitle(sceneId, selfId,  5, 124)
				LuaFnDispatchAllTitle(sceneId, selfId)

			elseif ret > 0 then
--				AddItemListToHuman(sceneId,selfId)
				BeginUICommand(sceneId)
					UICommand_AddInt(sceneId,5)
					UICommand_AddInt(sceneId,2)
				EndUICommand(sceneId)
				DispatchUICommand(sceneId,selfId, 0)
			end
			
		else
			--°ÑÇ°Ãæ¼ÓtoÕ ðµ ÈÎÎñÉ¾µô,add by hukai#39191
			DelMission( sceneId, selfId, x311010_g_MissionId )
			
			BeginEvent(sceneId)
				strText = "Không th¬ thu ðßþc v§t ph¦m, không th¬ tiªp nh§n nhi®m vø"
				AddText(sceneId,strText);
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
			
		end
			
	end

end

--**********************************
--µ¯³ö½»Ò×½çÃæ
--¾ÍÐúngTÕi äîÔËÊ¹´¦ ði¬m»÷ÁË¡°ÂòÂôäî»õ¡±»òÕß ði¬m»÷»õÉÌ,²¢Ëæ»úµ¯³öÁË½»Ò×½çÃæ
--**********************************
function x311010_OnPopupBargainingUI( sceneId, selfId )

	  if IsMissionHaveDone(sceneId,selfId,x311010_g_MissionId) > 0 then
	   	return 
		end
		
--Èç¹ûÒÑ½Ó´ËÈÎÎñ
    if IsHaveMission(sceneId,selfId,x311010_g_MissionId) > 0 then
  	  local ItemNum = GetItemCount(sceneId,selfId,x311010_g_CashItem_id)

			if ItemNum < x311010_g_CashItem_count then
				BeginUICommand(sceneId)
					UICommand_AddInt(sceneId,5)
					UICommand_AddInt(sceneId,6)
				EndUICommand(sceneId)
				DispatchUICommand(sceneId,selfId, 0)
				x311010_OnAbandon( sceneId, selfId )
				return
			end
--fix here

    	local Mission_Round =	GetMissionData(sceneId,selfId,MD_CAOYUN_HUAN)
			BeginUICommand(sceneId)
				--µÚ1Î»±íÊ¾Cái này UI¾ßÌåÐúngÄÄ²½.
				UICommand_AddInt(sceneId,3)
				
				local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)

				local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
				local TransNpc = x311010_TransPortNPC(sceneId,targetId)
--				PrintStr("targetId="..targetId.." TransNpc="..TransNpc)
				if TransNpc == 0 or TransNpc == -1 then
					return
				end
				
				--µÚ2Î»±íÊ¾Cái này ÈÎÎñË÷ÒýºÅ.
				UICommand_AddInt(sceneId,misIndex)

				local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
				Quotiety = 1
				local Price_Buy = 10000 * Quotiety
				local Price_Sell = Price_Buy * 150 / 100

				Price_Sell = x311010_Calculate_Margin( sceneId, selfId, Price_Sell )
				--µÚ3Î»±íÊ¾ÂòtoÕ ðµ ¼Û¸ñ
				UICommand_AddInt(sceneId,Price_Buy)

				--µÚ4Î»±íÊ¾ÂôtoÕ ðµ ¼Û¸ñ
				UICommand_AddInt(sceneId,Price_Sell)

				--µÚ5Î»±íÊ¾ÈÎÎñ½Å±¾toÕ ðµ ID
				UICommand_AddInt(sceneId,x311010_g_ScriptId)

				--µÚ6Î»±íÊ¾»õÉÌ²»ÊÕÄÄÖÖÉÌÆ·
				UICommand_AddInt(sceneId,1)
				
				--µÚ7Î»±íÊ¾µ±Ç°»¹Ê£toÕ ðµ PriceUpÊ±¼ä
				Pre_Time = GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINUP)
				Now_Time = LuaFnGetCurrentTime();
				if Now_Time - Pre_Time < 10*60 then
					UICommand_AddInt(sceneId,Pre_Time + 10*60 - Now_Time)
				else
					UICommand_AddInt(sceneId,0)
				end
				
				--µÚ8Î»±íÊ¾µ±Ç°»¹Ê£toÕ ðµ PriceDownÊ±¼ä
				Pre_Time = GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINDOWN)
				if Now_Time - Pre_Time < 15*60 then
					UICommand_AddInt(sceneId,Pre_Time + 15*60 - Now_Time)
				else
					UICommand_AddInt(sceneId,0)
				end

--client ÒªÏÔÊ¾³ö½»Ò×½çÃæ,¸ù¾ÝÉÏÃætoÕ ðµ µÚmµt cái²ÎÊý,À´·ÅÑÎ¡¢Ìú¡¢Ã×toÕ ðµ buttonºÍÏÔÊ¾É±¼ÛÈÈÏúbutton
				UICommand_AddInt(sceneId,TransNpc)
				
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 1)
			

		end

end

--**********************************
--¹ºÂmµt òÂô³öÄ³cáiÑÎ,Ìú,Ã×
--Client\Interface\Carriage\Carriage.lua
--Carriage_Action_Clicked()µ÷ÓÃ
--**********************************
function x311010_OnTrade( sceneId, selfId, ManipulateID )

	if LuaFnIsCanDoScriptLogic(sceneId, selfId) < 1 then
		return
	end
	
  if IsHaveMission(sceneId,selfId,x311010_g_MissionId) < 1   then
  	return
  end
	
--ÅÐ¶ÏËûÐúng·ñ¿ÉÒÔ²Ù×÷Õâ²½
--should add some code

			local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
--			local TransNPC = GetMissionParam(sceneId,selfId,misIndex,6)
			local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
			local TransNPC = x311010_TransPortNPC(sceneId,targetId)
			local trade = 0;

			if TransNPC == 0 or TransNPC == -1 then
				return
			end

	-- hongyu  
	-- Èç¹ûÍæ¼Ò´«¹ýÀ´mµt cáiÎÞ¹ØtoÕ ðµ Öµ,Ö±½Ó¶ªÆú
	if ManipulateID~=1 and ManipulateID~=2 and ManipulateID~=3  then
		return
	end
	-- ¿Í»§¶Ë·¢¹ýÀ´toÕ ðµ  ManipulateID ÓÐ1,2,3Õâ3cáiÖµ,·Ö±ð±íÊ¾
	--  		1		ÑÎ	LÕc Dß½ng	0
	-- 			2		Ìú	ÐÕi Lý	2
	--			3		Ã×	Tô Châu	1
	--
	
	local nData = GetMissionParam(sceneId,selfId,misIndex,2)
	nData = mod(nData,1000)
	local nData1 = floor(nData/100)
	local nData2 = floor((nData-nData1*100)/10)
	local nData3 = floor(nData - nData1*100 - nData2*10)
	-- ÑÎ
	if ManipulateID == 1  then
		if sceneId == 0   then
			if nData1~=0  then
				return
			end
		else
			-- Íæ¼ÒÇëÇóÖ´ÐÐÂòÈë²Ù×÷,¼ì²âÍæ¼ÒÐúng²»ÐúngÒÑ¾­Âò¹ýÁËCái này ¶«Î÷
			if nData1==0  then
				return
			end
		end
	end
	-- Ìú
	if ManipulateID == 2  then
		if sceneId == 2   then
			-- Íæ¼ÒÇëÇóÖ´ÐÐÂô³ö²Ù×÷,¼ì²âÍæ¼ÒÐúng²»ÐúngÓÐ¶«Î÷¿ÉÂô³ö
			if nData2~=0  then
				return
			end
		else
			-- Íæ¼ÒÇëÇóÖ´ÐÐÂòÈë²Ù×÷,¼ì²âÍæ¼ÒÐúng²»ÐúngÒÑ¾­Âò¹ýÁËCái này ¶«Î÷
			if nData2==0  then
				return
			end
		end
	end
	-- Ã×
	if ManipulateID == 3  then
		if sceneId == 1   then
			-- Íæ¼ÒÇëÇóÖ´ÐÐÂòÈë²Ù×÷,¼ì²âÍæ¼ÒÐúng²»ÐúngÓÐ¿Õ¼ä¿ÉÂòÈë
			if nData3~=0  then
				return
			end
		else
			-- Íæ¼ÒÇëÇóÖ´ÐÐÂòÈë²Ù×÷,¼ì²âÍæ¼ÒÐúng²»ÐúngÒÑ¾­Âò¹ýÁËCái này ¶«Î÷
			if nData3==0  then
				return
			end
		end
	end
	-- hongyu end.


--cargo
--1 ¶ÔÑÎ²Ù×÷
--2	¶ÔÌú²Ù×÷
--3	¶ÔÃ×²Ù×÷

--trade
--0	Âò
--1 Âô
--²»ÓÃÕâÎ»ÅÐ¶ÏÁË.

--¸ù¾ÝCái này NPCºÍPlayerÉíÉÏtoÕ ðµ Çé¿öÀ´ÅÐ¶Ï,¶ÔÑÎ,Ìú,Ã×Cái này ¶«Î÷ÐúngÂmµt ¹ÐúngÂô
			if ManipulateID == TransNPC then

--ÕâÊ±Ðúng¹ºÂòÑÎ
--ÏÈÅÐ¶ÏCái này PlayerÐúng·ñÒÑ¾­¹ºÂòÁËÑÎ
					
					
					local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
					Price_Down = GetMissionParam(sceneId,selfId,misIndex,1)
					Cargo			= GetMissionParam(sceneId,selfId,misIndex,2)
					local Cargo_Standard = 0;
					local purchased = 0;

--ÏÈÅÐ¶ÏCái này PlayerÐúng·ñÒÑ¾­¹ºÂòÁËÑÎ
					if TransNPC == 1 then
						Cargo_Standard = 100;
						if mod(Cargo,1000) >= Cargo_Standard then
							purchased = 1;							
						end
					elseif TransNPC == 2 then
						Cargo_Standard = 10;
						if mod(Cargo,100) >= Cargo_Standard then
							purchased = 1;
						end
					elseif TransNPC == 3 then
						Cargo_Standard = 1;
						if mod(Cargo,10) >= Cargo_Standard then
							purchased = 1;
						end
					elseif TransNPC == 4 then
						Cargo_Standard = 1000;
						if mod(Cargo,10000) >= Cargo_Standard then
							purchased = 1;
						end
					end
						
					if purchased > 0 then
					
						BeginUICommand(sceneId)
							UICommand_AddInt(sceneId,5)
							UICommand_AddInt(sceneId,7)
							UICommand_AddInt(sceneId,ManipulateID)
						EndUICommand(sceneId)
						DispatchUICommand(sceneId,selfId, 0)
				
						return
					end
--should add some code
--					local Mission_Round =	GetMissionData(sceneId,selfId,MD_CAOYUN_HUAN)
--					if Mission_Round >= 20 then
--						BeginEvent(sceneId)
--							strText="Äã¿ìÈ¥¶mµt »¹ÙÆ±°É,±¾´Î½»Ò×ÒÑ¾­³¬ÏÞ."
--							AddText(sceneId,strText);
--						EndEvent(sceneId)
--						DispatchMissionTips(sceneId,selfId)
--						return
--					end


					if Price_Down == 0 then
--Ã»ÓÐ¾­¹ýÉ±¼Û,ÕâÀïÒªÖØÐÂ¼ÆËãµ½µ×¸Ã¶àÉÙÇ®¹ºÂò
--should add some code
--***					--ºÍÉÏÃæÄ³²¿·ÖÏàÍ¬¾Í¿ÉÒÔ
						local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
						Quotiety = 1
						Price_Down = 10000 * Quotiety
						Pre_Time = GetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINDOWN)
						Now_Time = LuaFnGetCurrentTime();
						
						--È¡Ëæ»úÊý
						--Ëæ»ú¸øÍæ¼Òcái¶«¶«
						local nMoney = GetMoney(sceneId,selfId)
						local nLevel = GetLevel( sceneId, selfId )
						if (Now_Time - Pre_Time >= 15*60) and floor(mod(nMoney / 31 * 17 + 73 + nLevel,21596+Quotiety)) == 15982 then
							BeginAddItem(sceneId)
							AddItem( sceneId,30103001, 1 )
							ret = EndAddItem(sceneId,selfId)
							if ret > 0 then
								AddItemListToHuman(sceneId,selfId)
								BeginEvent(sceneId)
									strText = "Các hÕ không trä giá, v§n may t¯t, mµt cái Dß½ng Sâm Th± r½i t× trên tr¶i vào túi cüa các hÕ"
									AddText(sceneId,strText);
								EndEvent(sceneId)
								DispatchMissionTips(sceneId,selfId)
							else
							--½±ÀøÎïÆ·Ã»ÓÐ¼Ó³É¹¦
								BeginEvent(sceneId)
									strText = "Túi xách ðã ð¥y, không th¬ l¤y thêm v§t ph¦m t£ng thß·ng"
									AddText(sceneId,strText);
								EndEvent(sceneId)
								DispatchMissionTips(sceneId,selfId)
							end
						end
					end

					Balance = GetMissionParam(sceneId,selfId,misIndex,5)
					
					if Balance < Price_Down then
						BeginEvent(sceneId)
							strText = "S¯ v¯n lßu ðµng Tào v§n không ðü ð¬ mua món hàng này."
							AddText(sceneId,strText)
						EndEvent(sceneId)
						DispatchMissionTips(sceneId,selfId)
						return
					end
					
					if x311010_OnAdd_CaoyunTime( sceneId, selfId ) <= 0 then
						return 0
					end
					
					Balance = Balance - Price_Down;
					SetMissionByIndex(sceneId,selfId,misIndex,5,Balance)
					SetMissionByIndex(sceneId,selfId,misIndex,1,0)
					Cargo = Cargo + Cargo_Standard
					SetMissionByIndex(sceneId,selfId,misIndex,2,Cargo)
						BeginEvent(sceneId)
							if (ManipulateID ==1) then
								strText = "Các hÕ ðã mua thành công mµt ph¥n mu¯i"
							elseif ( ManipulateID == 2) then
								strText = "Các hÕ ðã mua thành công mµt ph¥n s¡t"
							elseif( ManipulateID ==3) then
								strText = "Các hÕ ðã mua thành công mµt ph¥n gÕo"
							elseif( ManipulateID ==4) then
								strText = "Các hÕ ðã mua thành công mµt ph¥n mu¯i riêng"
							end
							AddText(sceneId,strText);
						EndEvent(sceneId)
						DispatchMissionTips(sceneId,selfId)
					--²¢°ÑÉíÉÏtoÕ ðµ ±ê¼ÇÎ»ÖÃÎªÂòÈëÁËÑÎ
					--¸æËßclientTÕi UIÉÏÎÒtoÕ ðµ »õ²ÕÄÚ,ÏÔÊ¾ÑÎ
					BeginUICommand(sceneId)
							UICommand_AddInt(sceneId,5)
							UICommand_AddInt(sceneId,11)
							UICommand_AddInt(sceneId,Price_Down)
					EndUICommand(sceneId)
					DispatchUICommand(sceneId,selfId, 0)
					SetMissionByIndex(sceneId,selfId,misIndex,3,ManipulateID)
					--¼ÇÂ¼ÏÂÍæ¼Ò¸Õ¸ÕÂò¹ýtoÕ ðµ äîÔËÎïÆ·.
				else
					--if TransNPC == 2 or TransNPC == 3 or TransNPC ==4 then
					--ÕâÊ±Ðúng³öÊÛÑÎ
					misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
					Price_Up = GetMissionParam(sceneId,selfId,misIndex,0)
					
					local bUp = 0
					if Price_Up == 0  then
						bUp = 0
					else
						bUp = 1
					end
					
					if bUp == 0  then
						Price_Up = 15000
					else
						Price_Up = 18000
					end
										
					Cargo			= GetMissionParam(sceneId,selfId,misIndex,2)
	
					--ÏÈÅÐ¶ÏCái này PlayerÐúng·ñÒÑ¾­¹ºÂòÁËÑÎ
					--should add some code
					
					local Cargo_Standard=0
					local purchased = 0;
					
					--ÏÈÅÐ¶ÏCái này PlayerÐúng·ñÒÑ¾­¹ºÂòÁËÑÎ
					if ManipulateID == 1 then
						Cargo_Standard = 100
						if mod(Cargo,1000) < Cargo_Standard then
							purchased = 1;
						end
					elseif ManipulateID == 2 then
						Cargo_Standard = 10
						if mod(Cargo,100) < Cargo_Standard then
							purchased = 1;
						end
					elseif ManipulateID == 3 then
						Cargo_Standard = 1
						if mod(Cargo,10) < Cargo_Standard then
							purchased = 1;
						end
					elseif ManipulateID == 4 then
						Cargo_Standard = 1000
						if mod(Cargo,10000) < Cargo_Standard then
							purchased = 1;
						end
					end
					
					if purchased > 0 then
						BeginUICommand(sceneId)
							UICommand_AddInt(sceneId,5)
							UICommand_AddInt(sceneId,8)
							UICommand_AddInt(sceneId,ManipulateID)
						EndUICommand(sceneId)
						DispatchUICommand(sceneId,selfId, 0)
						
						return
					end
					
					local HaveChop = x311010_Calculate_Double( sceneId, selfId )
					local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
					Quotiety = 1
					if HaveChop == 2 then
						--if bUp == 0 then
						--	Price_Up = 20000 * Quotiety
						--else
						--	Price_Up = 26000 * Quotiety
						--end
						
						Price_Up = (Price_Up-10000) * 2 + 10000
						
						BeginEvent(sceneId)
							strText = format("Do ðß¶ng Tào v§n mà ðem lÕi lþi nhu§n cho các hÕ ðÕt l¾n h½n g¤p bµi.")
							AddText(sceneId,strText)
		 				EndEvent(sceneId)                                                                                                                                                                                                                                          
	 					DispatchMissionTips(sceneId,selfId)
	 					Msg2Player( sceneId,selfId,"Do ðß¶ng Tào v§n mà ðem lÕi lþi nhu§n cho các hÕ ðÕt l¾n h½n g¤p bµi.",MSG2PLAYER_PARA)

					end

					--if Price_Up == 0 then
					----Ã»ÓÐ¾­¹ýÈÈÏú,ÕâÀïÒªÖØÐÂ¼ÆËãµ½µ×¸Ã¶àÉÙÇ®¹ºÂò
					--	Quotiety = 1
					--	Price_Up = 15000 * Quotiety
					--end
					
					local SpecialDay = x311010_Calculate_Calender( sceneId, selfId )
					
					if SpecialDay == 2 then
						Price_Up = (Price_Up-10000) * 2 + 10000
					end
					
					if GetMissionParam(sceneId,selfId,misIndex,4) == ManipulateID then
						Price_Up = floor(Price_Up * 110 / 100)
						SetMissionByIndex(sceneId,selfId,misIndex,4,0)
					end
					
	
					
					Price_Up = x311010_Calculate_Margin( sceneId, selfId, Price_Up )
					Balance = GetMissionParam(sceneId,selfId,misIndex,5)
					INP = 10000;
					--***INPÒª¸ù¾ÝÊ±¼ä±ä»¯
--Íõmµt ´¨¸øtoÕ ðµ ¹«Ê½
--					Balance = Balance + Price_Up + INP * 10 * mod( GetMissionData(sceneId,selfId,2) , 10 ) / 100;
--Î¤ÇàËµ²»³ËINP
					Balance = Balance + Price_Up
					SetMissionByIndex(sceneId,selfId,misIndex,5,Balance)
					SetMissionByIndex(sceneId,selfId,misIndex,0,0)
					--²¢°ÑÉíÉÏtoÕ ðµ ±ê¼ÇÎªÖÃÎªÂô³öÁË»õÎï

					Cargo = Cargo - Cargo_Standard

					SetMissionByIndex(sceneId,selfId,misIndex,2,Cargo)
					trade = 1
				--end

		BeginUICommand(sceneId)
			UICommand_AddInt(sceneId,5)
			UICommand_AddInt(sceneId,11)
			UICommand_AddInt(sceneId,Price_Up)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 0)
		
--²¢È¡ÈËÎïÉíÉÏCái này ¼Û¸ñÊý¾ÝÀ´Ö´ÐÐ²Ù×÷.
--Âô¾ÍÐúng½áÊøÕâ»·,»·ÊýÒª¸Ä±ä
		if trade == 1 then
--»·Êý+1
			misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
			local Mission_Round =	GetMissionData(sceneId,selfId,MD_CAOYUN_HUAN)
--missiondataÖÐµÚ2Î»¼ÇÂ¼toÕ ðµ ÐúngäîÔËtoÕ ðµ »·Êý
			SetMissionData(sceneId,selfId,MD_CAOYUN_HUAN,Mission_Round + 1)
			BeginEvent(sceneId)
				if (ManipulateID == 1) then
					strText = "Các hÕ ðã bán thành công mµt ph¥n mu¯i"
				elseif ( ManipulateID == 2) then
					strText = "Các hÕ ðã bán thành công mµt ph¥n s¡t"
				elseif ( ManipulateID ==3 ) then
					strText = "Các hÕ ðã bán thành công mµt ph¥n gÕo"
				elseif ( ManipulateID ==4 ) then
					strText = "Các hÕ ðã bán thành công mµt ph¥n mu¯i riêng"
				end
				AddText(sceneId,strText);
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
			
			BeginEvent(sceneId)
				strText = format("Thüy v§n l¥n này là vòng thÑ %d", (Mission_Round + 1))
				AddText(sceneId,strText);
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)

			-- ¼ÇÂ¼Íæ¼ÒÍê³Émµt ´ÎäîÔËtoÕ ðµ ÈÕÖ¾
			LuaFnAuditCaoyunDone(sceneId,selfId)
			
			--×ÜtoÕ ðµ äîÔË´ÎÊý+1

			Sum_Time = GetMissionData(sceneId,selfId,MD_CAOYUN_SUMTIME)			

			SetMissionData(sceneId,selfId,MD_CAOYUN_SUMTIME,Sum_Time+1)
				
			if random(100) <= 5 then
				local my_level = GetLevel( sceneId, selfId )
				local reward_item 

				local medicine_level = floor(my_level/10)
			
				if medicine_level < 1 then
					medicine_level = 1
				elseif medicine_level > 10 then
					medicine_level = 10
				end
				
				if random(100) <= 50 then
					reward_item = x311010_g_Reward_Medicine_HP[medicine_level]
				else
					reward_item = x311010_g_Reward_Medicine_MP[medicine_level]
				end
				ret = TryRecieveItem( sceneId, selfId, reward_item, QUALITY_MUST_BE_CHANGE)
				if ret > 0 then
					BeginEvent(sceneId)
						strText = format("Các hÕ ðÕt ðßþc #{_ITEM%d}.", reward_item)
						AddText(sceneId,strText);
					EndEvent(sceneId)
					DispatchMissionTips(sceneId,selfId)
				else
					SetMissionByIndex(sceneId,selfId,misIndex,3,4)
					--¼ÇÂ¼ÏÂÍæ¼ÒÓ¦¸ÃCác hÕ phäi ðªn ½±Àø¶øÃ»ÓÐCác hÕ phäi ðªn .
					local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
					BeginEvent(sceneId)
						AddText(sceneId,"Ð¬ khích l® cho nhæng c¯ng hiªn cüa các hÕ ð¯i v¾i Tào v§n, ta ð£c bi®t chu¦n b¸ cho các hÕ mµt ph¥n #{_ITEM"..reward_item.."}, nhßng túi xách cüa các hÕ ðã ð¥y r°i, không th¬ cho vào thêm ðßþc, hãy thu d÷n túi xách xong r°i thông báo cho ta biªt")
						AddNumText(sceneId,x311010_g_ScriptId,"Túi xách cüa ta ðã thu d÷n xong",-1,3)
						AddNumText(sceneId,x311010_g_ScriptId,"Bö ði, ta không c¥n næa",-1,0)
					EndEvent(sceneId)
					DispatchEventList(sceneId,selfId,targetId)
					
				end
					

			end
--			local Mission_Round =	GetMissionData(sceneId,selfId,MD_CAOYUN_HUAN)
--			if Mission_Round >= 22 then
--				BeginEvent(sceneId)
--					strText="Äã¿ìÈ¥¶mµt »¹ÙÆ±°É,±¾´Î½»Ò×ÒÑ¾­³¬ÏÞ."
--					AddText(sceneId,strText);
--				EndEvent(sceneId)
--				DispatchMissionTips(sceneId,selfId)
--			end




-----------------------------------------------------------
--			x311010_OnPopupBargainingUI( sceneId, selfId )
-----------------------------------------------------------
		end
		end
	
end

--**********************************
--¶mµt »¹ÙÆ±
--**********************************
function x311010_OnRedeemUI( sceneId, selfId )

	if LuaFnIsCanDoScriptLogic(sceneId, selfId) < 1 then
		return
	end

	  if IsMissionHaveDone(sceneId,selfId,x311010_g_MissionId) > 0 then
	   	return 
		end

    --Èç¹ûÒÑ½Ó´ËÈÎÎñ
    if IsHaveMission(sceneId,selfId,x311010_g_MissionId) > 0 then
				
				local ItemNum = GetItemCount(sceneId,selfId,x311010_g_CashItem_id)
				
				if ItemNum < x311010_g_CashItem_count then
					BeginUICommand(sceneId)
						UICommand_AddInt(sceneId,5)
						UICommand_AddInt(sceneId,4)
					EndUICommand(sceneId)
					DispatchUICommand(sceneId,selfId, 0)
					return
				end
				local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
				local Cargo	= GetMissionParam(sceneId,selfId,misIndex,2)
				if Cargo > 0 then
					BeginEvent(sceneId)	
						strText = format("Làm sÕch khoang xong m¾i ðßþc ð±i quan phiªu.")
						AddText(sceneId,strText);
					EndEvent(sceneId)
					DispatchMissionTips(sceneId,selfId)
					return
				end
			--½áÊø´ËÈÎÎñ,²¢¸ù¾Ý¹ÙÆ±ÉÏtoÕ ðµ Ãæ¶îÀ´¸øÓèÏà¹Ø½±Àø
			--Ç®ºÍKinh nghi®mµÈ
			--¿ÉÄÜ½±Àø»¹¸ú»·ÊýÓÐ¹ØÏµ
			--begin modified by zhangguoxin 090207
			--GetMissionData(sceneId,selfId,MD_CAOYUN_HUAN) 
			--local iDayCount = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT)/100000
			local iDayCount = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT);
			--end modified by zhangguoxin 090207
			
			BeginUICommand(sceneId)
				UICommand_AddInt(sceneId,5)
				UICommand_AddInt(sceneId,3)
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 0)
			
			misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
			Balance = GetMissionParam(sceneId,selfId,misIndex,5)
--			TransNPC = GetMissionParam(sceneId,selfId,misIndex,6)
			local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
			TransNPC = x311010_TransPortNPC(sceneId,targetId)
			
			if TransNPC == 4 then
				return
			end
--ÕâÀï²»¼ì²ébalance,ÒòÎªËùÓÐÂòtoÕ ðµ µØ·½¶¼ÅÅ³ýÁËÐúng·ñ»á³öÏÖ¸ºÊýtoÕ ðµ Çé¿ö
			local Quotiety = x311010_Calculate_Modulus( sceneId, selfId )
			Quotiety = 2
			local Corpus = 10000 * Quotiety
			local Margin = Balance - Corpus
			
			if x311010_OnAccomplished( sceneId, selfId ) ~= 1 then
				return
			end
			
			if	Margin > 0 then
				local Level = LuaFnGetLevel( sceneId, selfId)
--				Margin = Margin * (0.625+0.02*(Level-30)/2)
				--AddMoney(sceneId,selfId,Margin + Corpus);
				AddMoneyJZ(sceneId, selfId, 1.2*(Margin+Corpus));
				--¼ÇÂ¼Í³¼ÆÐÅÏ¢
				LuaFnAuditCaoYun(sceneId, selfId, iDayCount, 0, Margin)
--				BeginEvent(sceneId)	
--					strText = format("Äã ði¬mµ½#{_MONEY"..Margin.."}toÕ ðµ äîÔË»¨ºì.")
--					AddText(sceneId,strText);
--				EndEvent(sceneId)
--				DispatchMissionTips(sceneId,selfId)

				local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
				--local msg = "Chúc m×ngÄú½áÊøäîÔË,±¾ÂÖäîÔËCác hÕ ðÕt ðßþc »¨ºì#{_EXCHG"..Balance.."},¼ÓÉÏ20%¶îÍâÊÕÒæ,mµt ¹²Îª#{_EXCHG"..1.2*Balance.."}.¿Û³ýÑº½ðºó,Các hÕ ðÕt ðßþc »¨ºì#{_EXCHG"..1.2*Balance-Corpus.."}."
 				local msg = "Chúc m×ng các hÕ ðã kªt thúc Tào v§n, l¥n Tào v§n này các hÕ ðã ðÕt ðßþc t±ng cµng hoa h°ng #{_MONEY"..Balance.."}, sau khi tr× ti«n ð£t c÷c, các hÕ nh§n ðßþc hoa h°ng#{_MONEY"..Margin.."}"
 				local cmsg = "Tham ti«n tham ti«n.."
				x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg,0)

			elseif Balance > 0 then
				AddMoneyJZ(sceneId,selfId,Balance);
				--¼ÇÂ¼Í³¼ÆÐÅÏ¢
				LuaFnAuditCaoYun(sceneId, selfId, iDayCount, 0, 0)
				BeginEvent(sceneId)	
					strText = format("Các hÕ kinh doanh không lß½ng thi®n, không nh§n ðßþc hoa h°ng, chï nh§n ðßþc ti«n Tào v§n l¥n này #{_EXCHG"..Balance.."}." )
					AddText(sceneId,strText);
				EndEvent(sceneId)
				DispatchMissionTips(sceneId,selfId)
			else
				--¼ÇÂ¼Í³¼ÆÐÅÏ¢
				LuaFnAuditCaoYun(sceneId, selfId, iDayCount, 0, -Corpus)
				BeginEvent(sceneId)	
					strText = format("Các hÕ kinh doanh không lß½ng thi®n, không nh§n ðßþc hoa h°ng, mà m¤t luôn cä v¯n." )
					AddText(sceneId,strText);
				EndEvent(sceneId)
				DispatchMissionTips(sceneId,selfId)
			end
			--¿Û³ý¹ÙÆ±
			
			--x311010_OnAccomplished( sceneId, selfId )
			
			
		end

end


--**********************************
--ÅÐ¶ÏÓ¦¸Ã½áÊøËûtoÕ ðµ ´òÑ¹ÊÐ³¡toÕ ðµ cool down
--**********************************
function x311010_OnFinishHaggleDown( sceneId, selfId )

	local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
	SetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINDOWN,0)
			
	BeginUICommand(sceneId)
		UICommand_AddInt(sceneId,5)
		UICommand_AddInt(sceneId,14)
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 0)
	return
end

--**********************************
--ÅÐ¶ÏÓ¦¸Ã½áÊøËûtoÕ ðµ ºåÌ§Îï¼ÛtoÕ ðµ cool down
--**********************************
function x311010_OnFinishHaggleUp( sceneId, selfId )

	--½áÊøËûtoÕ ðµ ÈÈÏúCD
	local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
	SetMissionData(sceneId,selfId,MD_CAOYUN_BARGAINUP,0)
		
	BeginUICommand(sceneId)
		UICommand_AddInt(sceneId,5)
		UICommand_AddInt(sceneId,13)
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 0)
	return
end

--**********************************
--·ÅÆú
--**********************************
function x311010_OnAbandon( sceneId, selfId )

	x311010_OnAccomplished( sceneId, selfId )

	x311010_OnAbandon_Necessary( sceneId, selfId )
	
end

function x311010_OnAccomplished( sceneId, selfId )

	--ÒÆÈ¥ÈÎÎñÎïÆ·
	if DelItem( sceneId, selfId, x311010_g_CashItem_id, x311010_g_CashItem_count ) ~= 1 then 
		return 0 
	end 

--É¾³ýÍæ¼ÒÈÎÎñÁÐ±íÖÐ¶ÔÓ¦toÕ ðµ ÈÎÎñ
	local ret = DelMission( sceneId, selfId, x311010_g_MissionId )
	if ret > 0 then
--É¾³ý³ÆºÅ¡°äîÔËÉÌ¡± ËïÓê
		SetCurTitle(sceneId, selfId,  0, 124)
		DeleteTitle( sceneId, selfId,  5)
		LuaFnDispatchAllTitle(sceneId, selfId)	
--ÒÆÈ¥ÈÎÎñÎïÆ·
		--DelItem( sceneId, selfId, x311010_g_CashItem_id, x311010_g_CashItem_count )
		--SetMissionData(sceneId,selfId,MD_CAOYUN_HUAN,0)
		SetMissionData(sceneId,selfId,MD_CAOYUN_MONSTERTIMER,0)
	end
	LuaFnCancelSpecificImpact(sceneId,selfId,113)

	return 1
end

--**********************************
--Íæ¼ÒËÀÍö
--**********************************
function x311010_OnHumanDie( sceneId, selfId, killerId )
	local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
	local Balance = GetMissionParam(sceneId,selfId,misIndex,5)
	local Cargo =  GetMissionParam(sceneId,selfId,misIndex,2)
	x311010_OnAccomplished( sceneId, selfId )
	BeginEvent(sceneId)
		AddText(sceneId, "#{CYSB_081107_1}")
	EndEvent()
	DispatchMissionTips(sceneId, selfId)
	BroadMsgByChatPipe(sceneId, selfId, "#{CYSB_081107_1}", 8)
	if Balance > 1 then
		pos_x = GetHumanWorldX(sceneId,selfId)
		pos_z = GetHumanWorldZ(sceneId,selfId)
	
--		local ret = DropBoxEnterScene(	pos_x,pos_z,sceneId )
		
--		if ret > -1 then
--			AddItemToBox(sceneId,ret,QUALITY_MUST_BE_CHANGE,1,30001000)
--
--			--°´ÕÕ×îÐÂtoÕ ðµ ¼ÆËã·½·¨¼ÆËã³ötoÕ ðµ µôÂäµ½ÒøÆ±ÖÐtoÕ ðµ ½ðÇ®
--				--ÒøÆ±toÕ ðµ ¼ÛÖµ£½Íæ¼ÒäîÔËÖ¤ÉÏËùÓÐtoÕ ðµ ½ðÇ®¡ÁµÈc¤pÓ°ÏìÏµÊý.
--				--µÈc¤pÓ°ÏìÏµÊý¼ÆËã¹æÔòÈçÏÂ: 
--				--µ±Íæ¼ÒµÈc¤p<=30c¤pÊ±,µÈc¤pÓ°ÏìÏµÊý = 25%
--				--µ±Íæ¼ÒµÈc¤p>30c¤p²¢ÇÒ<=73c¤pÊ±,µÈc¤pÓ°ÏìÏµÊý = 25%*(Íæ¼ÒµÈc¤p/30)^1.27
--				--µ±Íæ¼ÒµÈc¤p>73c¤pÊ±,µÈc¤pÓ°ÏìÏµÊý = 80%
--				
--			local nLevel = GetLevel(sceneId, selfId)
--			local nQuotiety = 0
--			if nLevel <= 30  then
--				nQuotiety = 0.25
--			end
--			
--			if nLevel > 30 and nLevel <= 73  then
--				nQuotiety = 0.25 * ((nLevel/30)^1.27)
--			end
--			
--			if nLevel > 73   then
--				nQuotiety = 0.8
--			end
--			
--			local Corpus = Balance * nQuotiety
--			
--			Corpus = floor(Corpus)
--			SetBoxItemParam( sceneId, selfId, ret, 0, 0, 2, Corpus )
--		end
	end

end

--¼ì²â´ÎÊý
function x311010_OnAccept_Necessary( sceneId, selfId )
	local Level =GetLevel(sceneId, selfId)
	
	local Max_Time_EveryDay = 0

	if Level >= 70 then
		Max_Time_EveryDay = 50
	elseif Level >= 50 then
		Max_Time_EveryDay = 40
	elseif Level >= 30 then
		Max_Time_EveryDay = 30
	end
	--Î¤Çà5ÔÂ4ÈÕTÕi ÎÄµµÀïËµÒªÏÞÖÆ³É20´Î
	Max_Time_EveryDay = 20
	
	--begin modified by zhangguoxin 090207
	--local iDayCount=GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT)
	--local iTime = mod(iDayCount,100000)
	--local iDayTime = floor(iTime/100)	--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(ÌìÊý)
	--local iQuarterTime = mod(iTime,100)	--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(¿Ì)
	--local iDayHuan = floor(iDayCount/100000) --µ±ÌìÄÚÍê³ÉtoÕ ðµ S¯ l¥n nhi®m vø 
  --
	--local CurTime = GetHourTime()		--µ±Ç°Ê±¼ä
	--local CurDaytime = floor(CurTime/100)	--µ±Ç°Ê±¼ä(Ìì)
	--local CurQuarterTime = mod(CurTime,100)	--µ±Ç°Ê±¼ä(¿Ì)
	local iDayHuan = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT); --µ±ÌìÄÚÍê³ÉtoÕ ðµ S¯ l¥n nhi®m vø 
	
	local iTime = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYTIME);			--ÉÏ´ÎHoàn t¤t nhi®m vøÊ±¼ä
	local iDayTime = floor(iTime/100)																		--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(ÌìÊý)
	local iQuarterTime = mod(iTime,100)																	--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(¿Ì)
		
	local CurTime = GetQuarterTime()																		--µ±Ç°Ê±¼ä
	local CurDaytime = floor(CurTime/100)																--µ±Ç°Ê±¼ä(Ìì)
	local CurQuarterTime = mod(CurTime,100)															--µ±Ç°Ê±¼ä(¿Ì)
	--end modified by zhangguoxin 090207

	if iTime == CurTime then
		BeginEvent(sceneId)
			strText = format("Th¶i gian chßa ðªn các hÕ không nh§n ðßþc nhi®m vø Tào v§n.")
			AddText(sceneId,strText)
		EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return -1
	end
	

	if CurDaytime==iDayTime then 	--ÉÏ´ÎHoàn t¤t nhi®m vøÐúngÍ¬mµt ÌìÄÚ
		if iDayHuan >= Max_Time_EveryDay then
--			BeginEvent(sceneId)
--				strText = format("Cái này ÈÎÎñmµt Ìì×î¶à×ö%d´Î.", Max_Time_EveryDay )
--				AddText(sceneId,strText)
--			EndEvent(sceneId)
--			DispatchMissionTips(sceneId,selfId)

			local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
			local msg = "Xin l²i, nhi®m vø Tào v§n ngày hôm nay cüa các hÕ ðã ð¥y "..Max_Time_EveryDay.." MÑc gi¾i hÕn cao nh¤t l¥n trß¾c, xin các hÕ ngày mai quay lÕi."
	 		local cmsg = "Ta biªt r°i.."
			x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg,0)

			return -1
		end
--		iDayHuan = iDayHuan+1
	else							--ÉÏ´ÎHoàn t¤t nhi®m vø²»TÕi Í¬mµt Ìì,ÖØÖÃ
		iDayTime = CurDaytime
		iDayHuan = 0
	end
	--begin modified by zhangguoxin 090207
	--iDayCount = iDayHuan*100000+CurDaytime*100+iQuarterTime
	----PrintStr("accept:"..iDayCount)
	--SetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT,iDayCount)
	local newTime = CurDaytime*100+iQuarterTime;
	SetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT,iDayHuan);
	SetMissionData(sceneId,selfId,MD_CAOYUN_DAYTIME,newTime);
	--end modified by zhangguoxin 090207
	return 1
	
end
--Ôö¼Ó´ÎÊý
function x311010_OnAdd_CaoyunTime( sceneId, selfId )
	local Level =GetLevel(sceneId, selfId)
	
	local Max_Time_EveryDay = 0

	if Level >= 70 then
		Max_Time_EveryDay = 50
	elseif Level >= 50 then
		Max_Time_EveryDay = 40
	elseif Level >= 30 then
		Max_Time_EveryDay = 30
	end
	--Î¤Çà5ÔÂ4ÈÕTÕi ÎÄµµÀïËµÒªÏÞÖÆ³É20´Î
	Max_Time_EveryDay = 20
	
	--begin modified by zhangguoxin 090207
	--local iDayCount=GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT)
	--local iTime = mod(iDayCount,100000)
	--local iDayTime = floor(iTime/100)	--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(ÌìÊý)
	--local iQuarterTime = mod(iTime,100)	--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(¿Ì)
	--local iDayHuan = floor(iDayCount/100000) --µ±ÌìÄÚÍê³ÉtoÕ ðµ S¯ l¥n nhi®m vø 
  --
	--local CurTime = GetHourTime()		--µ±Ç°Ê±¼ä
	--local CurDaytime = floor(CurTime/100)	--µ±Ç°Ê±¼ä(Ìì)
	--local CurQuarterTime = mod(CurTime,100)	--µ±Ç°Ê±¼ä(¿Ì)
	local iDayHuan = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT); --µ±ÌìÄÚÍê³ÉtoÕ ðµ S¯ l¥n nhi®m vø 
	
	local iTime = GetMissionData(sceneId,selfId,MD_CAOYUN_DAYTIME);			--ÉÏ´ÎHoàn t¤t nhi®m vøÊ±¼ä
	local iDayTime = floor(iTime/100)																		--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(ÌìÊý)
	local iQuarterTime = mod(iTime,100)																	--ÉÏmµt ´Î½»ÈÎÎñtoÕ ðµ Ê±¼ä(¿Ì)
	
	local CurTime = GetQuarterTime()																		--µ±Ç°Ê±¼ä
	local CurDaytime = floor(CurTime/100)																--µ±Ç°Ê±¼ä(Ìì)
	local CurQuarterTime = mod(CurTime,100)															--µ±Ç°Ê±¼ä(¿Ì)
	--end modified by zhangguoxin 090207
	
--	if iTime == CurTime then
--		BeginEvent(sceneId)
--			strText = format("Ê±¼äÎ´µ½,»¹²»ÄÜ½ÓäîÔËÈÎÎñ.")
--			AddText(sceneId,strText)
--		EndEvent(sceneId)
-- 		DispatchMissionTips(sceneId,selfId)
--		return -1
--	end
	

	if CurDaytime==iDayTime then 	--ÉÏ´ÎHoàn t¤t nhi®m vøÐúngÍ¬mµt ÌìÄÚ
		local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
		local Cargo			= GetMissionParam(sceneId,selfId,misIndex,2)
		if Cargo > 0 and iDayHuan >= Max_Time_EveryDay-1 then
		
		end
		if (iDayHuan >= Max_Time_EveryDay) then
--			BeginEvent(sceneId)
--				strText = format("Cái này ÈÎÎñmµt Ìì×î¶à×ö%d´Î.", Max_Time_EveryDay )
--				AddText(sceneId,strText)
--			EndEvent(sceneId)
--			DispatchMissionTips(sceneId,selfId)
			local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
--			local msg = "¶Ô²»Æð,Äú½ñÌìËù´ÓÊÂtoÕ ðµ äîÔËÈÎÎñÒÑ¾­Âú"..Max_Time_EveryDay.."´ÎÉÏÏÞ,ÇëÄúÃ÷ÌìÔÙÀ´°É."
			local msg = "S¯ l¥n Tào v§n hôm nay cüa các hÕ ðã ðÕt mÑc gi¾i hÕn 20 l¥n."
	 		local cmsg = "Ta biªt r°i.."
			x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg,0)

			return -1
		end
		iDayHuan = iDayHuan+1
	else							--ÉÏ´ÎHoàn t¤t nhi®m vø²»TÕi Í¬mµt Ìì,ÖØÖÃ
		iDayTime = CurDaytime
		iDayHuan = 0
	end
	
	--begin modified by zhangguoxin 090207
	--iDayCount = iDayHuan*100000+CurDaytime*100+iQuarterTime
	----PrintStr("add time:"..iDayCount)
	--SetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT,iDayCount)
	local newTime = CurDaytime*100+iQuarterTime;
	SetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT,iDayHuan);
	SetMissionData(sceneId,selfId,MD_CAOYUN_DAYTIME,newTime);
	--end modified by zhangguoxin 090207
	return 1
end

--·ÅÆúÊ±¼ÇÂ¼Ê±¼ä
function x311010_OnAbandon_Necessary( sceneId, selfId )
	--begin modified by zhangguoxin 090207
	--local iDayCount=GetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT)
	--local iTime = mod(iDayCount,100000)
	--local iDayHuan = floor(iDayCount/100000) --µ±ÌìÄÚÍê³ÉtoÕ ðµ S¯ l¥n nhi®m vø 
  --
	--local CurTime = GetHourTime()		--µ±Ç°Ê±¼ä
	--
	--iDayCount = iDayHuan*100000+CurTime
  --
	--	
	--SetMissionData(sceneId,selfId,MD_CAOYUN_DAYCOUNT,iDayCount)
	local CurTime = GetQuarterTime()		--µ±Ç°Ê±¼ä
	SetMissionData(sceneId,selfId,MD_CAOYUN_DAYTIME,CurTime);
	--end modified by zhangguoxin 090207
	return 1
	
end

function x311010_OnPlayerCaoyunTimer( sceneId, selfId )

	local Detect = 0
	for i, eachId in x311010_g_Traverse_Region do
		if eachId == sceneId then
			Detect = 1
		end
	end
	
	local Orientation_Article = 0
	local Article_Quantity
	for i, item in x311010_g_EludeItem do
		Article_Quantity = GetItemCount( sceneId, selfId, item.id )
		if Article_Quantity ~= item.num then
			Orientation_Article = 1
		end
	end

	if LuaFnHaveImpactOfSpecificDataIndex(sceneId, selfId, 137) ~= 0 then
		return
	end

	if LuaFnHaveImpactOfSpecificDataIndex(sceneId, selfId, 136) ~= 0 and random(2) == 1 then
		return
	end

	if Detect == 1 and Orientation_Article == 1 then	
		local rrr = random(100)
		if random(2) < 3 then
			local iMonsterCount=GetMissionData(sceneId,selfId,MD_CAOYUN_MONSTERTIMER)
			if iMonsterCount < 4 then
				iMonsterCount = iMonsterCount + 1
			end
			if iMonsterCount == 1 or iMonsterCount == 2 then

				SetMissionData(sceneId,selfId,MD_CAOYUN_MONSTERTIMER,iMonsterCount)
				
				-- ÓöäîÔË¹ÖÓÐ20%¼¸ÂÊ±äÎª´ðÌâ hongyu ------
				if random(100) <= 20  then
					LuaFnSendGuajiQuestion(sceneId,selfId)
					return
				end
				-- hongyu end ----------------------------
				
				pos_x = GetHumanWorldX(sceneId,selfId)
				pos_z = GetHumanWorldZ(sceneId,selfId)
				
				local Level_Self = GetLevel( sceneId, selfId )
				local Adapt = floor( (Level_Self-1) / 10);	
				if Adapt < 1 then
					Adapt = 1
				elseif Adapt > 20 then   -- modify by zchw  
					Adapt = 20
				end
				local Monster_Id = x311010_g_Accommodate_Distinction[Adapt];
				npcobjid = LuaFnCreateMonster( sceneId, Monster_Id, pos_x,pos_z, 10,95, 311011 )
				x311010_Diversification( sceneId, npcobjid )
--				Msg2Player(  sceneId, selfId,"@*;npcpaopao;"..npcobjid..";15",MSG2PLAYER_PARA )
--				Msg2Player(  sceneId, selfId,"@*;npcpaopao;"..npcobjid..";16",MSG2PLAYER_PARA )
				SetLevel(sceneId, npcobjid,Level_Self-1)
				SetCharacterTimer( sceneId, npcobjid, 60000 )
				SetCharacterDieTime(sceneId, npcobjid, 60000 * 4 )
--				PaoPao(sceneId,selfId,npcobjid)
				AddPrimaryEnemy(sceneId,npcobjid,selfId)
				LuaFnSendSpecificImpactToUnit(sceneId,selfId,npcobjid,npcobjid,114,0)
				BeginEvent(sceneId)
					strText = format("Xin chú ý, n½i này có gi£c cß¾p xu¤t hi®n")
					AddText(sceneId,strText)
	 			EndEvent(sceneId)                                                                                                                                                                                                                                          
 				DispatchMissionTips(sceneId,selfId)
 				LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,37,0)
				LuaFnSendSpecificImpactToUnit(sceneId,selfId,npcobjid,npcobjid,37,0)
				LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,38,0)
				for i=1,2 do
					if ( rrr > 5 and i == 1 ) or ( rrr > 35 and i == 2) then 
						local Monster_Id =x311010_g_Acclimatize_Distinction[Adapt]
						local this_x,this_z = x311010_Random_Nativity(pos_x,pos_z,i)
						npcobjid = LuaFnCreateMonster( sceneId, Monster_Id, this_x,this_z, 10,95, 311011 )
						x311010_Diversification( sceneId, npcobjid )
	--Ö»ÓÐ¹ÖÎïÍ·Ä¿Ã°ÅÝ
						if i == 1 then
							Msg2Player(  sceneId, selfId,"@*;npcpaopao;"..npcobjid..";15",MSG2PLAYER_PARA )
						else
							Msg2Player(  sceneId, selfId,"@*;npcpaopao;"..npcobjid..";16",MSG2PLAYER_PARA )
						end
						SetLevel(sceneId, npcobjid,Level_Self-2)
						SetCharacterTimer( sceneId, npcobjid, 60000 )
						SetCharacterDieTime(sceneId, npcobjid, 60000 * 4)
	--					PaoPao(sceneId,selfId,npcobjid)
						AddPrimaryEnemy(sceneId,npcobjid,selfId)
						LuaFnSendSpecificImpactToUnit(sceneId,selfId,npcobjid,npcobjid,114,0)
						LuaFnSendSpecificImpactToUnit(sceneId,selfId,npcobjid,npcobjid,37,0)
	
					end
				end
			elseif iMonsterCount == 100 then
				SetMissionData(sceneId,selfId,MD_CAOYUN_MONSTERTIMER,0)
			end
		end
	else
		SetCharacterTimer( sceneId, selfId, 0 )
	end
end

function x311010_OnPlayerEnterCaoyunScene( sceneId, selfId )

	local find = 0
	for i, eachId in x311010_g_Traverse_Region do
		if eachId == sceneId then
			find = 1
		end
	end
	
	if find == 1 then	
		SetCharacterTimer( sceneId, selfId, 45000 )
		SetMissionData(sceneId,selfId,MD_CAOYUN_MONSTERTIMER,100)
		BeginEvent(sceneId)
			strText = format("Xin chú ý, n½i này có gi£c cß¾p xu¤t hi®n")
			AddText(sceneId,strText)
		EndEvent(sceneId)                                                                                                                                                                                                                                          
		DispatchMissionTips(sceneId,selfId)
	else
		SetCharacterTimer( sceneId, selfId, 0 )
	end
	return 1
end

function x311010_Diversification( sceneId, MonsterId )
	--ÉèÖÃmonstertoÕ ðµ ³ÆºÅ
	ret = random(7)
	local part1 = x311010_g_TitleTableOfMonster[ret].part1
	ret = random(7)
	local part2 = x311010_g_TitleTableOfMonster[ret].part2
	local str = format("%s%s", part1, part2)
	SetCharacterTitle(sceneId, MonsterId, str)
	--ÉèÖÃmonstertoÕ ðµ name
	ret = random(8)
	local part1 = x311010_g_NameTableOfMonster[ret].part1
	ret = random(8)
	local part2 = x311010_g_NameTableOfMonster[ret].part2
	ret = random(8)
	local part3 = x311010_g_NameTableOfMonster[ret].part3
	local part4 = ""
	local rd = random(4)
	
	if rd == 1 then
		part4 = format("%s%s" , part2, part3)
	elseif rd == 2 then
		part4 = part2
	elseif rd == 3 then
		part4 = part3
	else
		part4 = format("%s%s" , part3, part2)
	end
	
	str = format("%s%s", part1, part4)
	
	SetCharacterName(sceneId, MonsterId, str)
	return 1	
end

function x311010_IsSkillLikeScript( sceneId, selfId)
	return 0;
end

function x311010_Random_Nativity(position_x,position_z,Range)
	local Variety_X,Variety_Z;
	if position_x > 2 then
		Variety_X = position_x - 1 + random(3)+random(Range+1)
	end
	
	if position_z > 2 then
		Variety_Z = position_z - 1 + random(3)+random(Range+1)
	end

	return Variety_X,Variety_Z
end

function x311010_Client_Show_Message( sceneId, selfId, targetId, Message, CloseMessage, NumText)

	BeginEvent(sceneId)

		AddText(sceneId,Message)
		AddNumText(sceneId,x311010_g_ScriptId,CloseMessage,-1,NumText)

	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)
	
end

function x311010_OnHandle_QuestUI( sceneId, selfId, targetId, NumText )
--	PrintStr("NumText="..NumText)
	if NumText == 0 then
		BeginUICommand(sceneId)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 1000)
	elseif NumText == 1 then
		BeginUICommand(sceneId)
			UICommand_AddInt(sceneId,3)
			UICommand_AddInt(sceneId,targetId)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 0)
	elseif NumText == 2 then
		local Caoyun_Times =  GetMissionData(sceneId,selfId,MD_CAOYUN_SUMTIME)	
		local find = -1
		for i, times in x311010_g_Title_Times_Confine do
			if times <= Caoyun_Times then
				find = i
				break
			end
		end

--		BeginUICommand(sceneId)
--		EndUICommand(sceneId)
--		DispatchUICommand(sceneId,selfId, 1000)
--		
--		local New_Title = x311010_g_Title_Confine[find]
--
--		LuaFnAwardTitle( sceneId, selfId,  5, New_Title)
--		SetCurTitle(sceneId, selfId,  5, New_Title)
--		LuaFnDispatchAllTitle(sceneId, selfId)
		
		BeginUICommand(sceneId)
			UICommand_AddInt(sceneId,5)
			UICommand_AddInt(sceneId,2)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 0)
		
	elseif NumText == 3 then
		BeginUICommand(sceneId)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 1000)
		local my_level = GetLevel( sceneId, selfId )
		local medicine_level = floor(my_level/10)
		local reward_item 
		
		if medicine_level < 1 then
			medicine_level = 1
		elseif medicine_level > 10 then
			medicine_level = 10
		end
		
		if random(100) < 50 then
			reward_item = x311010_g_Reward_Medicine_HP[medicine_level]
		else
			reward_item = x311010_g_Reward_Medicine_MP[medicine_level]
		end
		TryRecieveItem( sceneId, selfId, reward_item, QUALITY_MUST_BE_CHANGE )
	elseif NumText > 3 and NumText < 17 then
		BeginUICommand(sceneId)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 1000)
		local Scene_Info = x311010_g_Transportation_Exit[sceneId]
		if Scene_Info then
			for i=1,2 do
				if Scene_Info[i].Exit_Reply_Number == NumText then
					SetPos( sceneId, selfId, Scene_Info[i].Exit_Position.x, Scene_Info[i].Exit_Position.y )
				end				
			end
		end

	elseif NumText > 16 and NumText < 20 then
		BeginUICommand(sceneId)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 1000)
		local Scene_Info = x311010_g_Transportation_City[NumText-17]
		
		if Scene_Info then
			local rrr= random(3)-1
			NewWorld( sceneId, selfId, NumText-17, Scene_Info[rrr].x, Scene_Info[rrr].y )
		end
	elseif NumText > 19 and NumText < 23 then
		BeginUICommand(sceneId)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 1000)
		local Scene_Info = x311010_g_Transportation_Legate[NumText-20]
		
		if Scene_Info then
			NewWorld( sceneId, selfId, NumText-20, Scene_Info.Position.x, Scene_Info.Position.y )
		end
	elseif NumText > 22 and NumText < 27 then
			BeginUICommand(sceneId)
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 1000)
			local my_level = GetLevel( sceneId, selfId )
			if my_level>=30 and my_level<40 then
				level_phase = 1
			elseif my_level>=40 and my_level<55 then
				level_phase = 2
			elseif my_level>=55 and my_level<65 then
				level_phase = 3
			elseif my_level>=65 and my_level<75 then
				level_phase = 4
			elseif my_level>=75 and my_level<85 then
				level_phase = 5
			elseif my_level>=85 and my_level<95 then
				level_phase = 6
			elseif my_level>=95 and my_level<105 then
				level_phase = 7
			elseif my_level>=105 and my_level<115 then
				level_phase = 8
			elseif my_level >= 115 then
				level_phase = 9
			end
			LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,x311010_g_SpecialImpact[NumText].Impact_ID[level_phase],0)
	elseif NumText == 27 then
		BeginUICommand(sceneId)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 1000)
		LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,x311010_g_IncreaseSpeed_Impact[NumText].Impact_ID,0)
	elseif NumText == 28 then
		x311010_Monger_Random(sceneId,selfId)
	end

end

function x311010_TransPortNPC(sceneId,targetId)

		local TransportNPCName=GetName(sceneId,targetId);
		
		local type = GetCharacterType(sceneId,targetId);
		
		if type ~=2 then 
			return -1
		end
		
		if TransportNPCName == "Tri®u Minh Thành" then
			return 1
		elseif TransportNPCName == "Løc Sî Tranh" then
			return 3
		elseif TransportNPCName == "Vß½ng Nhßþc Vû" then
			return 2
		elseif TransportNPCName == "H¡c th¸ thß½ng nhân" then
			return 4
		else 
			return -1
		end
end

--*****************************************************
--Íæ¼ÒLînh ¹ÙÆ±²¢¹ºÂò±¾µØ»õÎïºó¸øÍæ¼ÒËæ»ú¼ÓÈýÖÖºÃ´¦
--Client\Interface\Carriage\Carriage.lua
--x311010_Close_Carriage_UI()µ÷ÓÃ
--*****************************************************
function x311010_Close_Carriage_UI( sceneId, selfId )
	
	--Ã»ÓÐäîÔËÈÎÎñ¾ÍÖ±½ÓÍË³ö--add by xindefeng
	if IsHaveMission(sceneId,selfId,x311010_g_MissionId) <= 0 then
			return
  end

	local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
	local Statue = GetMissionParam(sceneId,selfId,misIndex,3)
--	PrintStr("statue="..Statue)
	if Statue == 1 or Statue == 2 or Statue == 3 then
		SetMissionByIndex(sceneId,selfId,misIndex,3,0)
		local rrr = random(100)
		local strText
		if rrr <= 2 and GetMissionParam(sceneId,selfId,misIndex,4) <= 0 then
			
			if (Statue ==1) then
				strText = "Mu¯i"
			elseif ( Statue == 2) then
				strText = "Thiªt"
			elseif( Statue ==3) then
				strText = " GÕo"
			end
			local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
			local msg = "Chúc m×ng các hÕ, hàng hóa Tào v§n cüa các hÕ l¥n này thuµc c¤p 1"..strText.."Sau l¥n Tào v§n này, lþi nhu§n cüa các hÕ tång lên 10%."
 			local cmsg = "V§n may t¯t l¡m.."

			x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			SetMissionByIndex(sceneId,selfId,misIndex,4,Statue)
			--TÕi ÌØÊâ×´Ì¬Î»¼ÇÂ¼ÏÂµ±Ê±toÕ ðµ äî»õ
		elseif rrr <= 5 then
			local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
			local msg = "Chúc m×ng các hÕ, l¥n Tào v§n này các hÕ có ðßþc lính gác bäo v®, nhß v§y các hÕ s¨ không g£p phäi tên cß¾p hàng nào."
 			local cmsg = "V§n may t¯t l¡m.."

			x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,137,0)
		elseif rrr <= 10 then
			local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
			local msg = "Chúc m×ng các hÕ, các hÕ may m¡n l¡m, trong quá trình Tào v§n, khä nång g£p phäi cß¾p cüa các hÕ chï còn 50%."
 			local cmsg = "V§n may t¯t l¡m.."

			x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,136,0)
		end
	end
end

function x311010_Monger_Random(sceneId,selfId)
			local targetId = GetMissionData(sceneId,selfId,MD_CAOYUN_TARGETID)
			local misIndex = GetMissionIndexByID(sceneId,selfId,x311010_g_MissionId)
			
			TRAFFICKER_CLICK_TIMES = TRAFFICKER_CLICK_TIMES + 1
			
			local  PlayerSex=GetSex(sceneId,selfId)
			if PlayerSex == 0 then
				PlayerSex = "Næ hi®p"
			else
				PlayerSex = "ÐÕi hi®p"
			end
			
--Ðúng·ñ³öÏÖ³öÊÛäî»õ
			local rrr = random(100)
				
			if rrr < 0 then
--ÆÁ±ÎºÚÊÐÉÌÈËtoÕ ðµ Ë½ÑÎ
						
				local msg = "Th§t ðáng tiªc, v§n may cüa các hÕ không t¯t.."
 				local cmsg = "L¥n sau ta s¨ ðªn.."
				x311010_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
					
--						BeginUICommand(sceneId)
--							UICommand_AddInt(sceneId,3)
--						--client ÒªTÕi UI ÉÏÏÔÊ¾"ÂòÂôäî»õ"ºÍ"¶mµt »¹ÙÆ±"Õâ2cáibutton
--							UICommand_AddInt(sceneId,targetId)
--						--²¢ÇÒ°ÑNPCtoÕ ðµ ID´«¸øclient,ÒÔ±¸ÏÂmµt ²½µ÷ÓÃ.
--						EndUICommand(sceneId)
--						DispatchUICommand(sceneId,selfId, 0)

			elseif rrr <= 20 then
			--´«ËÍÖÁ±¾µØÍ¼toÕ ðµ Èë¿Ú
				
				local City_Exit = x311010_g_Transportation_Exit[sceneId]
				if City_Exit then
					BeginEvent(sceneId)
		
						AddText(sceneId,PlayerSex.."}, các hÕ cûng v¤t vä quá, ta nên giúp các hÕ mµt ít, hy v÷ng l¥n sau các hÕ có th¬ chiªu c¯ ðªn chuy®n làm ån cüa ta h½n, ta có th¬ ðem hàng hóa cüa các hÕ ðªn cØa ra vào tiªp theo trên bän ð°, các hÕ mu¯n ði ðâu?")
							AddNumText(sceneId,x311010_g_ScriptId,"Ta mu¯n ðªn"..City_Exit[1].Exit_Name.."CØa vào cüa",-1,City_Exit[1].Exit_Reply_Number)
							AddNumText(sceneId,x311010_g_ScriptId,"Ta mu¯n ðªn"..City_Exit[2].Exit_Name.."CØa vào cüa",-1,City_Exit[2].Exit_Reply_Number)
							AddNumText(sceneId,x311010_g_ScriptId,"Hay là ð¬ ta tñ ði",-1,0)
					EndEvent(sceneId)
					DispatchEventList(sceneId,selfId,targetId)
				end
					
			elseif rrr <= 40 then
			--´«ËÍÖÁThành ph¯ toÕ ðµ ÄÚ²¿
				BeginEvent(sceneId)
		
					AddText(sceneId,PlayerSex.."}, các hÕ cûng v¤t vä quá, ta nên giúp các hÕ mµt ít, hy v÷ng l¥n sau các hÕ có th¬ chiªu c¯ ðªn chuy®n làm ån cüa ta h½n, ta có th¬ ðem hàng hóa cüa các hÕ ðªn thành ph¯ mà các hÕ mu¯n ðªn các hÕ mu¯n ði ðâu?")
	
					for i=0,getn(x311010_g_Transportation_City) do
						AddNumText(sceneId,x311010_g_ScriptId,"Ta mu¯n ði "..x311010_g_Transportation_City[i].Scene_Name,-1,x311010_g_Transportation_City[i].Reply_Number)
					end

					AddNumText(sceneId,x311010_g_ScriptId,"Hay là ð¬ ta tñ ði",-1,0)
						
				EndEvent(sceneId)
				DispatchEventList(sceneId,selfId,targetId)
			elseif rrr <= 40 then
			--´«ËÍÖÁäîÔËÊ¹´¦
				BeginEvent(sceneId)
		
					AddText(sceneId,PlayerSex.."}, các hÕ cûng v¤t vä quá, ta nên giúp các hÕ mµt ít, hy v÷ng l¥n sau các hÕ có th¬ chiªu c¯ ðªn chuy®n làm ån cüa ta h½n, ta có th¬ ðem hàng hóa cüa các hÕ ðªn Tào v§n g¥n ðây, các hÕ mu¯n ði ðâu?")
	
					for i=0,getn(x311010_g_Transportation_Legate) do
						AddNumText(sceneId,x311010_g_ScriptId,"Ta mu¯n ði "..x311010_g_Transportation_Legate[i].Scene_Name.." Thüy v§n cüa ",-1,x311010_g_Transportation_Legate[i].Reply_Number)
					end

					AddNumText(sceneId,x311010_g_ScriptId,"Hay là ð¬ ta tñ ði",-1,0)
						
				EndEvent(sceneId)
				DispatchEventList(sceneId,selfId,targetId)
			elseif rrr <= 48 then
					
				local find,level_phase
				if rrr < 43 then
				--Ôö¼ÓÍâ¹¦¹¥»÷
					find = 23
				elseif rrr < 45 then
				--Ôö¼ÓÄÚ¹¦¹¥»÷
					find = 24
				elseif rrr < 47 then
				--Ôö¼ÓÍâ¹¦·ÀÓù
					find = 25
				elseif rrr < 49 then
				--Ôö¼ÓÄÚ¹¦·ÀÓù
					find = 26
				end

				BeginEvent(sceneId)
		
					AddText(sceneId,"Ðß¶ng Tào v§n r¤t nguy hi¬m, ta ðây có th¬ giúp ðßþc chút ít cho các hÕ, có th¬ cho các hÕ mµt ít"..x311010_g_SpecialImpact[find].Impact_Name..", nhßng mà l¥n sau nªu nhß ta có hàng mu¯n bán ra, các hÕ phäi giúp ta m¾i ðßþc")
	
					AddNumText(sceneId,x311010_g_ScriptId,"Ðßþc thôi",-1,find)
					AddNumText(sceneId,x311010_g_ScriptId,"Hay là ð¬ ta tñ ði",-1,0)
						
				EndEvent(sceneId)
				DispatchEventList(sceneId,selfId,targetId)
			else
			--Ôö¼ÓËÙ¶È
				BeginEvent(sceneId)
	
					AddText(sceneId,"Ðß¶ng Tào v§n còn r¤t dài, ta ðây có th¬ cho các hÕ mµt ít giúp ðÞ, giúp các hÕ gia tång t¯c ðµ trong th¶i gian ng¡n, nhßng nh¾ là mai này phäi chiªu c¯ ðªn chuy®n làm ån cüa ta, nhà ta già trë ð«u trông nh¶ vào ta nuôi s¯ng h÷")

					AddNumText(sceneId,x311010_g_ScriptId,"Ðßþc thôi",-1,27)
					AddNumText(sceneId,x311010_g_ScriptId,"Hay là ð¬ ta tñ ði",-1,0)
						
				EndEvent(sceneId)				
				DispatchEventList(sceneId,selfId,targetId)
			end
			return
end

