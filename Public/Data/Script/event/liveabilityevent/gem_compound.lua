-- ±¦Ê¯ºÏ³É

-- ½Å±¾ºÅ
x701602_g_scriptId = 701602

-- ½Å±¾Ãû³Æ
x701602_g_scriptName = "Hþp thành bäo ng÷c"

-- ºÏ³É¹æÔò±í
x701602_g_CompoundRule = {
	{
		[1] = { SpecialStuff = 30900015, MoneyCost = 5000, CountTable = { [3] = { SuccOdds = 25, SuccOddsWithSpecStuff = 50, }, [4] = { SuccOdds = 50, SuccOddsWithSpecStuff = 75, }, [5] = { SuccOdds = 75, SuccOddsWithSpecStuff = 100, }, }, },
		[2] = { SpecialStuff = 30900015, MoneyCost = 6000, CountTable = { [3] = { SuccOdds = 25, SuccOddsWithSpecStuff = 50, }, [4] = { SuccOdds = 50, SuccOddsWithSpecStuff = 75, }, [5] = { SuccOdds = 75, SuccOddsWithSpecStuff = 100, }, }, },
		[3] = { SpecialStuff = 30900015, MoneyCost = 7000, CountTable = { [3] = { SuccOdds = 25, SuccOddsWithSpecStuff = 50, }, [4] = { SuccOdds = 50, SuccOddsWithSpecStuff = 75, }, [5] = { SuccOdds = 75, SuccOddsWithSpecStuff = 100, }, }, },
		[4] = { SpecialStuff = 30900016, MoneyCost = 8000, CountTable = { [3] = { SuccOdds = 25, SuccOddsWithSpecStuff = 50, }, [4] = { SuccOdds = 50, SuccOddsWithSpecStuff = 75, }, [5] = { SuccOdds = 75, SuccOddsWithSpecStuff = 100, }, }, },
		[5] = { SpecialStuff = 30900016, MoneyCost = 9000, CountTable = { [3] = { SuccOdds = 25, SuccOddsWithSpecStuff = 50, }, [4] = { SuccOdds = 50, SuccOddsWithSpecStuff = 75, }, [5] = { SuccOdds = 75, SuccOddsWithSpecStuff = 100, }, }, },
		[6] = { SpecialStuff = 30900016, MoneyCost = 10000, CountTable = { [3] = { SuccOdds = 25, SuccOddsWithSpecStuff = 50, }, [4] = { SuccOdds = 50, SuccOddsWithSpecStuff = 75, }, [5] = { SuccOdds = 75, SuccOddsWithSpecStuff = 100, }, }, },
--		[7] = { SpecialStuff = 30900016, MoneyCost = 11000, CountTable = { [3] = { SuccOdds = 25, SuccOddsWithSpecStuff = 50, }, [4] = { SuccOdds = 50, SuccOddsWithSpecStuff = 75, }, [5] = { SuccOdds = 75, SuccOddsWithSpecStuff = 100, }, }, },
--		[8] = { SpecialStuff = 30900016, MoneyCost = 12000, CountTable = { [3] = { SuccOdds = 25, SuccOddsWithSpecStuff = 50, }, [4] = { SuccOdds = 50, SuccOddsWithSpecStuff = 75, }, [5] = { SuccOdds = 75, SuccOddsWithSpecStuff = 100, }, }, },
	},
	{
		[1] = { SpecialStuff = -1, MoneyCost = 500, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
		[2] = { SpecialStuff = -1, MoneyCost = 1000, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
		[3] = { SpecialStuff = -1, MoneyCost = 1500, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[4] = { SpecialStuff = -1, MoneyCost = 5000, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, }, -- modify by cuiyinjie ¿ª·Å4c¤p3TinhºÏ³É
--		[5] = { SpecialStuff = -1, MoneyCost = 2500, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[6] = { SpecialStuff = -1, MoneyCost = 3000, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[7] = { SpecialStuff = -1, MoneyCost = 3500, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[8] = { SpecialStuff = -1, MoneyCost = 4000, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
	},
	{
		[1] = { SpecialStuff = -1, MoneyCost = 10000, CountTable = { [3] = { SuccOdds = 0, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 0, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[2] = { SpecialStuff = -1, MoneyCost = 1000, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[3] = { SpecialStuff = -1, MoneyCost = 1500, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[4] = { SpecialStuff = -1, MoneyCost = 2000, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[5] = { SpecialStuff = -1, MoneyCost = 2500, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[6] = { SpecialStuff = -1, MoneyCost = 3000, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[7] = { SpecialStuff = -1, MoneyCost = 3500, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
--		[8] = { SpecialStuff = -1, MoneyCost = 4000, CountTable = { [3] = { SuccOdds = 50, SuccOddsWithSpecStuff = 0, }, [4] = { SuccOdds = 75, SuccOddsWithSpecStuff = 0, }, [5] = { SuccOdds = 100, SuccOddsWithSpecStuff = 0, }, }, },
	},
}

-- ºÏ³É²ÄÁÏÐþÌìº®Óñ
x701602_g_HanYu_MaterialId = 20310110
-- Éú³ÉÎïº®ÓñTinhËé
x701602_g_HanYu_OutPutId = 20310111

--**********************************************************************
-- ÈÎÎñÈë¿Úº¯Êý
--**********************************************************************
function x701602_OnDefaultEvent( sceneId, selfId, targetId )

	BeginUICommand(sceneId)
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 23)

end

--**********************************************************************
-- ÁÐ¾ÙÊÂ¼þ
--**********************************************************************
function x701602_OnEnumerate( sceneId, selfId, targetId )

	AddNumText(sceneId, x701602_g_scriptId, x701602_g_scriptName,6,-1)

end

--**********************************************************************
-- ÅÐ¶ÏÐúng·ñ±¦Ê¯
--**********************************************************************
function x701602_IsGem( itemIndex )
	if floor( itemIndex / 10000000 ) == 5 then
		return 1
	end

	return 0
end

--**********************************************************************
-- ÅÐ¶ÏÐúng·ñ²ÄÁÏ
--**********************************************************************
function x701602_IsMaterial( itemIndex )
	--if floor( itemIndex / 100000 ) == 205 then
	--	return 1
	--end

	if itemIndex >= 20500000 and itemIndex <= 20500008 then
		return 1
	end

	if itemIndex >= 20501000 and itemIndex <= 20501008 then
		return 1
	end

	if itemIndex >= 20502000 and itemIndex <= 20502008 then
		return 1
	end

	return 0
end

--**********************************************************************
-- ¸ù¾Ýmµt cáiÎïÆ·ºÅ ði¬mµ½¸ÃÎïÆ·toÕ ðµ ´ó·ÖÀà
--**********************************************************************
function x701602_GetStuffClass( itemIndex )
	if x701602_IsGem( itemIndex ) == 1 then
		return 1
	elseif x701602_IsMaterial( itemIndex ) == 1 then
		return 2
	elseif itemIndex == x701602_g_HanYu_MaterialId then
		return 3
	end

	return -1
end

--**********************************************************************
-- ¸ù¾Ýmµt cáiÎïÆ·ºÅ ði¬mµ½¸ÃÎïÆ·toÕ ðµ ÀàÐÍ
--**********************************************************************
function x701602_GetStuffType( itemIndex )
	if x701602_IsGem( itemIndex ) == 1 then
		return mod( itemIndex, 100000 )
	elseif x701602_IsMaterial( itemIndex ) == 1 then
		return LuaFnGetItemType( itemIndex )
	elseif itemIndex == x701602_g_HanYu_MaterialId then
		return LuaFnGetItemType( itemIndex )
	end

	return -1
end

--**********************************************************************
-- ¸ù¾Ýmµt cáiÎïÆ·ºÅ ði¬mµ½¸ÃÎïÆ·toÕ ðµ µÈc¤p
--**********************************************************************
function x701602_GetStuffGrade( itemIndex )
	if x701602_IsGem( itemIndex ) == 1 then
		return GetItemQuality( itemIndex )
	elseif x701602_IsMaterial( itemIndex ) == 1 then
		return GetCommonItemGrade( itemIndex )
	elseif itemIndex == x701602_g_HanYu_MaterialId then
		return GetCommonItemGrade( itemIndex )
	end

	return -1
end

--**********************************************************************
-- ¸ù¾Ýmµt cáiÎïÆ·ºÅ ði¬mµ½¸ÃÎïÆ·toÕ ðµ Éýc¤pÎïÆ·ºÅ
--**********************************************************************
function x701602_GetStuffUpgraded( itemIndex )
	if x701602_IsGem( itemIndex ) == 1 then
		return ( itemIndex + 100000 )
	elseif x701602_IsMaterial( itemIndex ) == 1 then
		return ( itemIndex + 1 )
	elseif itemIndex == x701602_g_HanYu_MaterialId then
		return x701602_g_HanYu_OutPutId
	end

	return -1
end

--**********************************************************************
-- ±¦Ê¯ÒÔ¼°²ÄÁÏºÏ³É½Ó¿Ú
-- bagIndex1, bagIndex2 ... bagIndex5: Îåcái±¦Ê¯»ò²ÄÁÏËùTÕi toÕ ðµ ¸ñ×Ó
-- bagIndex6: ÌØÊâ²ÄÁÏ
--**********************************************************************
function x701602_GemCompound( sceneId, selfId, bagIndex1, bagIndex2, bagIndex3, bagIndex4, bagIndex5, bagIndex6 )
	local bagIndexList = { bagIndex1, bagIndex2, bagIndex3, bagIndex4, bagIndex5 }
	local stuffList = { -1, -1, -1, -1, -1 }
	local stuffCount = 0					-- ²ÄÁÏcáiÊý
	local specialStuff = -1					-- ÌØÊâ²ÄÁÏ
	local CompoundClass = -1				-- ²ÄÁÏ´óÀà[·ÖÎª±¦Ê¯ºÍ²ÄÁÏ]
	local CompoundType = -1					-- ²ÄÁÏÖÖÀà[¸÷ÖÖ±¦Ê¯ÒÔ¼°¸÷ÖÖ²ÄÁÏ]
	local stuffGrade = -1					-- ²ÄÁÏµÈc¤p
	local standardStuff = -1
	local IsBind = 0;
	
	for i = 1, 5 do
		if LuaFnGetItemCountInBagPos(sceneId, selfId, bagIndexList[i]) >= 2 then
			BeginEvent( sceneId )
				AddText( sceneId, "Nguyên li®u ðang xªp ch°ng!" )
			EndEvent( sceneId )
			DispatchMissionTips( sceneId, selfId )
			return
		end
	end
	
	if bagIndex6 ~= -1 then
		local CCHTP = LuaFnGetItemTableIndexByIndex( sceneId, selfId, bagIndex6 )
		if CCHTP == 30900016 then
			local Author, szAuthor = LuaFnGetItemCreator(sceneId,selfId,bagIndex6);
			if szAuthor then
			
			else
				BeginEvent( sceneId )
					AddText( sceneId, "V§t ph¦m không hþp l®!" )
				EndEvent( sceneId )
				DispatchMissionTips( sceneId, selfId )
				return
			end
		end
	end
	local szTransferItem1 = GetBagItemTransfer( sceneId, selfId, bagIndex1 )
	
	-- ²»ÔÊÐíÓÐÖØ¸´toÕ ðµ bagIndexList³öÏÖ added by dun.liu 2009.2.5
	local isUnique = ScriptGlobal_IsUniqueNumberTable(bagIndexList);
	if isUnique == 0 then
		return OR_ERROR;
	end

	for i = 1, 5 do
		if bagIndexList[i] ~= -1 then
			if LuaFnIsItemAvailable( sceneId, selfId, bagIndexList[i] ) < 1 then	-- Ê¹ÓÃÓÐÎÊÌâtoÕ ðµ ÎïÆ·ÔòÍË³öÁ÷³Ì
				return OR_STUFF_LACK
			else
				stuffList[i] = LuaFnGetItemTableIndexByIndex( sceneId, selfId, bagIndexList[i] )
				stuffCount = stuffCount + 1

				if CompoundClass == -1 and stuffGrade == -1 and CompoundType == -1 then
					standardStuff = stuffList[i]
					CompoundClass = x701602_GetStuffClass( standardStuff )
					stuffGrade = x701602_GetStuffGrade( standardStuff )
					CompoundType = x701602_GetStuffType( standardStuff )
				end
				
				--ÅÐ¶Ï²ÄÁÏÐúng·ñ·ûºÏ
				if x701602_IsMaterial( stuffList[i] ) == 1 and
					mod( stuffList[i], 10 ) > 8 then
					return OR_STUFF_LACK
				end
				
				--ÅÐ¶Ï±¦Ê¯Ðúng·ñ°ó¶¨	
				if(LuaFnGetItemBindStatus( sceneId, selfId, bagIndexList[i]) == 1) then
					IsBind = 1;
				end
				
			end
		end
	end

	local CompoundRule = x701602_g_CompoundRule[CompoundClass]
	if not CompoundRule then
		return OR_ERROR
	end

	if bagIndex6 ~= -1 then
		if LuaFnIsItemAvailable( sceneId, selfId, bagIndex6 ) < 1 then			-- Ê¹ÓÃÓÐÎÊÌâtoÕ ðµ ÎïÆ·ÔòºöÂÔ
			bagIndex6 = -1
		else
			specialStuff = LuaFnGetItemTableIndexByIndex( sceneId, selfId, bagIndex6 )
		end
	end

	for i = 1, 5 do
		if stuffList[i] ~= -1 then
			if CompoundClass ~= x701602_GetStuffClass( stuffList[i] )
			 or stuffGrade ~= x701602_GetStuffGrade( stuffList[i] )
			 or CompoundType ~= x701602_GetStuffType( stuffList[i] )
			then
				return OR_STUFF_LACK
			end
		end
	end

	if not CompoundRule[stuffGrade] then										-- ÕâÖÖÇé¿öÍ¨³£¶¼ÐúngÒÑ¾­ 9 c¤pÁË
		return OR_CANNOT_UPGRADE
	end
	--ºÏ³É8,9c¤p±¦Ê¯¹¦ÄÜ¹Ø±Õ
	--if stuffGrade > 6 then
		--return OR_CANNOT_UPGRADE
	--end
	
	
	local selfMoney = GetMoney( sceneId, selfId )  +  GetMoneyJZ(sceneId, selfId)  --½»×ÓÆÕ¼° Vega
	
	if  selfMoney  < CompoundRule[stuffGrade].MoneyCost then
		return OR_NOTENOUGH_MONEY												-- Ç®²»¹»,mµt °ãÓÉ¿Í»§¶Ë×ÔÐÐÌáÊ¾
	end

	if not CompoundRule[stuffGrade].CountTable[stuffCount] then
		return OR_STUFF_LACK
	end

	local SuccOdds = CompoundRule[stuffGrade].CountTable[stuffCount].SuccOdds

	if specialStuff ~= -1 then
		if specialStuff ~= CompoundRule[stuffGrade].SpecialStuff then			-- ÀÄóÄ³äÊýtoÕ ðµ ÌØÊâ²ÄÁÏ´¦Àí
			bagIndex6 = -1
			specialStuff = -1
		else
			SuccOdds = CompoundRule[stuffGrade].CountTable[stuffCount].SuccOddsWithSpecStuff
		end
	end
	
	-- ±ØÐëÌØÊâ²ÄÁÏ
	if specialStuff == -1 then
		if 1 == CompoundClass then --Èç¹û²ÄÁÏÎª±¦Ê¯,Ôò±ØÐëC¥n ÌØÊâ²ÄÁÏ
		return OR_ERROR
		end
	end

	-- ¼ÆËãÐÂÎïÆ·±àºÅ
	local newItemIndex = x701602_GetStuffUpgraded( standardStuff )

	-- ¿Û³ý²ÄÁÏ, mµt ¶¨ÒªÈ«²¿¿Û³ý³É¹¦,²ÅÄÜ¼ÌÐø½øÐÐ added by dun.liu 2009.2.5
	for i = 1, 5 do
		if bagIndexList[i] ~= -1 then
			local isEraseSuc = LuaFnEraseItem( sceneId, selfId, bagIndexList[i] );
			if( isEraseSuc == 0 ) then
				return OR_ERROR;
			end
		end
	end

	-- ¿Û³ýÌØÊâ²ÄÁÏ
	if bagIndex6 ~= -1 then
		--ÅÐ¶ÏÌØÊâ²ÄÁÏÐúng·ñ°ó¶¨ add by xindefeng
		if(LuaFnGetItemBindStatus( sceneId, selfId, bagIndex6) == 1) then
			IsBind = 1;--ÉèÖÃÇ¿ÖÆ°ó¶¨±êÖ¾
		end
		LuaFnEraseItem( sceneId, selfId, bagIndex6 )
	end

	-- ¿Û³ý½ðÇ®
	local ret = LuaFnCostMoneyWithPriority( sceneId, selfId, CompoundRule[stuffGrade].MoneyCost )  --½»×ÓÆÕ¼° Vega
	if ret < 0 then
		return OR_NOTENOUGH_MONEY
	end
	-- Éú³ÉºÏ³ÉÎï,×îºómµt cái 1 ÐúngÆ·ÖÊ,²»Ó°Ïì±¾ÀàÐÍºÏ³ÉÎï
	local maxStuffCountChange = 3;
	local maxSpecialStuffChange = 2;
	local maxStuffGrade = 8;
	
	local selectRandomIndex = 0;
	if CompoundClass == 2 then
		selectRandomIndex = 1;
	end
	
	if CompoundClass == 3 then
		selectRandomIndex = 2;
	end
	
	selectRandomIndex = selectRandomIndex * maxStuffGrade;
	selectRandomIndex = selectRandomIndex + (stuffGrade - 1);
	selectRandomIndex = selectRandomIndex * maxSpecialStuffChange;
	if specialStuff ~= -1 then
		selectRandomIndex = selectRandomIndex + 1;
	end
	selectRandomIndex = selectRandomIndex * maxStuffCountChange;
	selectRandomIndex = selectRandomIndex + (stuffCount - 3);
	local randValue = LuaFnCompoundRandom(selectRandomIndex);

	if randValue > SuccOdds then												-- ºÏ³Éth¤t bÕi
		LuaFnSendAbilityFailureMsg( sceneId, selfId, -1, -1, -1 )
		LuaFnAuditGemCompound( sceneId, selfId, 0, stuffList[1], stuffList[2], stuffList[3], stuffList[4], stuffList[5], -1 )
		
		BroadMsgByChatPipe( sceneId, selfId, "#W#{_INFOUSR" .. GetName( sceneId, selfId ) .. "}#cFF0000 trong mµt lúc quá c¯ g¡ng, ðã làm vÞ vøn "..stuffCount.." viên #W#{_INFOMSG" .. szTransferItem1 .. "}#cFF0000.", 4 )

	else
		res = LuaFnTryRecieveItemIgnoreFatigueState( sceneId, selfId, newItemIndex, QUALITY_MUST_BE_CHANGE)
		if res == -1 then
			return OR_FAILURE
		end
		--Ç¿ÖÆ°ó¶¨
		if(IsBind == 1) then
			LuaFnItemBind( sceneId, selfId, res);
		end
		
		--Ôö¼ÓÌØÐ§
		LuaFnSendSpecificImpactToUnit(sceneId, selfId, selfId, selfId, 49, 0);
		
		--ÐÑÄ¿ÌáÊ¾
		BeginEvent( sceneId )
			AddText( sceneId, "Hþp thành thành công" )
		EndEvent( sceneId )
		DispatchMissionTips( sceneId, selfId )
		
		if x701602_IsGem( newItemIndex ) == 1 then
			stuffGrade = x701602_GetStuffGrade( newItemIndex )
			--¹«¸æTinh¼ò,Ð¡ÓÚ4c¤ptoÕ ðµ ±¦Ê¯ºÏ³É²»·¢¹«¸æ
			if stuffGrade >= 1 then
				local szTransferItem = GetBagItemTransfer( sceneId, selfId, res )
				BroadMsgByChatPipe( sceneId, selfId, "#W#{_INFOUSR" .. GetName( sceneId, selfId ) .. "}#H träi qua 1 s¯ n± lñc, cu¯i cùng ðã hþp thành ðßþc #W#{_INFOMSG" .. szTransferItem .. "}#H.", 4 )
			end
		end

		LuaFnSendAbilitySuccessMsg( sceneId, selfId, -1, -1, newItemIndex )		-- ÌáÊ¾Éú³ÉÎï
		LuaFnAuditGemCompound( sceneId,selfId, 1,
			stuffList[1], stuffList[2], stuffList[3], stuffList[4], stuffList[5], newItemIndex )
	end

	return OR_OK
end
