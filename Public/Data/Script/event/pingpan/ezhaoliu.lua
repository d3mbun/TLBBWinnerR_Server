--¸±±¾ÈÎÎñ
--³ÂÓÀÈÊÒýµ¼¸±±¾

--************************************************************************
--MisDescBegin

--½Å±¾ºÅ
x311005_g_ScriptId = 311005

--¸±±¾Ãû³Æ
x311005_g_CopySceneName="Chiêng ð°ng cong"

--ÈÎÎñºÅ
x311005_g_MissionId = 4002

--Ä¿±êNPC
x311005_g_Name = "Lßu Ki®n Minh"

--Ðúng·ñÐúngTinhÓ¢ÈÎÎñ
x311005_g_IfMissionElite = 1

--ÈÎÎñ¹éÀà
x311005_g_MissionKind = 1

--********ÏÂÃæ¼¸ÏîÐúng¶¯Ì¬ÏÔÊ¾toÕ ðµ ÄÚÈÝ,ÓÃÓÚTÕi ÈÎÎñÁÐ±íÖÐ¶¯Ì¬ÏÔÊ¾ÈÎÎñÇé¿ö******
--Ñ­»·ÈÎÎñtoÕ ðµ Êý¾ÝË÷Òý,ÀïÃæ´æ×ÅÒÑ×ötoÕ ðµ »·Êý MD_PINPAN_HUAN
x311005_g_MissionRound = 1
--**********************************ÒÔÉÏÐúng¶¯Ì¬****************************

--ÈÎÎñÎÄ±¾ÃèÊö
x311005_g_MissionName="Bình ð¸nh phiªn loÕn"
x311005_g_MissionInfo="Chúng ta ðã n¡m rõ tình hình toàn bµ tình hình cüa Ngû Ðài S½n phän quân, các hÕ và Tr¥n Vînh Nhân liên kªt, giªt hªt toàn bµ phän quân, mµt tên cûng không ch×a!"  --ÈÎÎñÃèÊö
x311005_g_MissionTarget="Nh¶ sñ giúp ðÞ cüa Lßu Ki®n Minh tiªn vào doanh ð¸a cüa phän quân, giªt chªt 1 tên Phän Quân Thü Lînh, 13 tên Phän Quân Thü V®, 6 tên Phän Quân Môn V®."	--Møc tiêu nhi®m vø
x311005_g_ContinueInfo="Các hÕ phäi tiªp tøc c¯ g¡ng nhé!"	--Î´Hoàn t¤t nhi®m vøtoÕ ðµ npc¶Ô»°
x311005_g_MissionComplete="Cám ½n, chúng tôi cu¯i cùng cûng ðã dám ra khöi cØa r°i"	--Hoàn t¤t nhi®m vønpcËµ»°toÕ ðµ »°


--ÈÎÎñ½±Àø
x311005_g_MoneyBonus=909

--MisDescEnd
--************************************************************************

--½ÇÉ«Mission±äÁ¿Ë ði¬m÷
--0ºÅ: ÒÑ¾­Íê³ÉtoÕ ðµ »·Êý,TÕi ½ÓÊÕÈÎÎñÊ±ºò¸³Öµ
--1ºÅ: µ±Ç°ÈÎÎñÐúng·ñÍê³É(0Î´Íê³É£»1Íê³É)
--2ºÅ: µ±Ç°¸±±¾ÈÎÎñtoÕ ðµ ³¡¾°ºÅ
--3ºÅ: ½Ó¸±±¾ÈÎÎñÊ±ºòtoÕ ðµ ¶ÓÎéºÅ
--4ºÅ: Î´ÓÃ
--5ºÅ: Î´ÓÃ
--6ºÅ: Î´ÓÃ
--7ºÅ: Î´ÓÃ

x311005_g_LimitMembers=1 --¿ÉÒÔ½ø¸±±¾toÕ ðµ ×îÐ¡¶ÓÎéÈËÊý
x311005_g_TickTime=5 --»Øµ÷½Å±¾toÕ ðµ Ê±ÖÓÊ±¼ä(µ¥Î»:  giây/´Î)
x311005_g_LimitTotalHoldTime=120 --¸±±¾¿ÉÒÔ´æ»îtoÕ ðµ Ê±¼ä(µ¥Î»: ´ÎÊý)
x311005_g_CloseTick=6	--¸±±¾¹Ø±ÕÇ°µ¹¼ÆÊ±(µ¥Î»: ´ÎÊý)
x311005_g_NoUserTime=300 --¸±±¾ÖÐÃ»ÓÐÈËºó¿ÉÒÔ¼ÌÐø±£´ætoÕ ðµ Ê±¼ä(µ¥Î»:  giây)
x311005_g_Fuben_X=57.6
x311005_g_Fuben_Z=107.3

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x311005_OnDefaultEvent( sceneId, selfId, targetId )
	if( IsHaveMission(sceneId,selfId,x311005_g_MissionId) > 0)  then	--Èç¹ûÍæ¼ÒÒÑ¾­½ÓÁËCái này ÈÎÎñ
		misIndex = GetMissionIndexByID(sceneId,selfId,x311005_g_MissionId)
		bDone = x311005_CheckSubmit( sceneId, selfId )
		if GetName(sceneId,targetId) == x311005_g_Name then		--ÐúngÄ¿±êNPC
			BeginEvent(sceneId)
				AddText(sceneId,x311005_g_MissionName)
				AddText(sceneId,"Chu¦n b¸ xong chßa?")
			EndEvent( )
			DispatchMissionInfo(sceneId,selfId,targetId,x311005_g_ScriptId,x311005_g_MissionId)
		elseif bDone==1 then	--ÈÎÎñÒÑ¾­Íê³É,²¢ÇÒTÕi ½»ÈÎÎñtoÕ ðµ NPCÉÏ ði¬m»÷toÕ ðµ ÊÂ¼þ
			BeginEvent(sceneId)
				AddText(sceneId,x311005_g_MissionName)
				AddText(sceneId,x311005_g_MissionComplete)
				AddText(sceneId,"Các hÕ s¨ nh§n ðßþc: ")
				AddMoneyBonus(sceneId,x311005_g_MoneyBonus)
			EndEvent( )
			DispatchMissionDemandInfo(sceneId,selfId,targetId,x311005_g_ScriptId,x311005_g_MissionId,bDone)
		end
    elseif x311005_CheckAccept(sceneId,selfId) > 0 then		--Ã»ÓÐÈÎÎñ,Thöa mãnÈÎÎñ½ÓÊÕÌõ¼þ
		if GetName(sceneId,targetId) ~= x311005_g_Name then
			--·¢ËÍÈÎÎñTiªp thøÊ±ÏÔÊ¾toÕ ðµ ÐÅÏ¢
			BeginEvent(sceneId)
				AddText(sceneId,x311005_g_MissionName)
				AddText(sceneId,x311005_g_MissionInfo)
				AddText(sceneId,"Møc tiêu nhi®m vø: ")
				AddText(sceneId,x311005_g_MissionTarget)
				AddText(sceneId,"Các hÕ s¨ nh§n ðßþc: ")
				AddMoneyBonus(sceneId,x311005_g_MoneyBonus)
			EndEvent( )
			DispatchMissionInfo(sceneId,selfId,targetId,x311005_g_ScriptId,x311005_g_MissionId)
		end
    end
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x311005_OnEnumerate( sceneId, selfId, targetId )
	--Èç¹ûÒÑ½Ó´ËÈÎÎñ
	if IsHaveMission(sceneId,selfId,x311005_g_MissionId) > 0 then
		bDone = x311005_CheckSubmit( sceneId, selfId )
		if GetName(sceneId,targetId) == x311005_g_Name	and	bDone==0 then --ÈÎÎñNPC,ÈÎÎñÃ»Íê³É
			AddNumText(sceneId, x311005_g_ScriptId,x311005_g_MissionName);
		elseif	GetName(sceneId,targetId) ~= x311005_g_Name	and	bDone==1 then --½»ÈÎÎñtoÕ ðµ NPC, ÈÎÎñÍê³É
			AddNumText(sceneId, x311005_g_ScriptId,x311005_g_MissionName);
		end
	--Thöa mãnÈÎÎñ½ÓÊÕÌõ¼þ
    elseif x311005_CheckAccept(sceneId,selfId) > 0 then
		if GetName(sceneId,targetId) ~= x311005_g_Name then
			AddNumText(sceneId,x311005_g_ScriptId,x311005_g_MissionName);
		end
    end
end

--**********************************
--¼ì²âTiªp thøÌõ¼þ
--**********************************
function x311005_CheckTeamLeader( sceneId, selfId )
	if	GetTeamId( sceneId, selfId)<0	then	--ÅÐ¶ÏÐúng·ñÓÐ¶ÓÎé
		BeginEvent(sceneId)
	  		AddText(sceneId,"Các hÕ phäi gia nh§p vào mµt ðµi ngû");
	  	EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return	0
	end
	--È¡ ði¬mÍæ¼Ò¸½½ütoÕ ðµ ¶ÓÓÑÊýÁ¿(°üÀ¨×Ô¼º)
	local	nearteammembercount = GetNearTeamCount( sceneId, selfId) 
	
	if	nearteammembercount<x311005_g_LimitMembers	then
		BeginEvent(sceneId)
	  		AddText(sceneId,"S¯ ngß¶i trong ðµi ngû cüa các hÕ không ðü");
	  	EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return	 0
	end
	
	if	LuaFnIsTeamLeader( sceneId, selfId)==0	then	--Ö»ÓÐ¶Ó³¤²ÅÄÜ½ÓÈÎÎñ
		BeginEvent(sceneId)
	  		AddText(sceneId,"Ngß¶i không phäi là nhóm trß·ng");
	  	EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return	 0
	end
	
	return nearteammembercount
end

--**********************************
--¼ì²âTiªp thøÌõ¼þ
--**********************************
function x311005_CheckAccept( sceneId, selfId )
	if	GetTeamId( sceneId, selfId)<0	then	--ÅÐ¶ÏÐúng·ñÓÐ¶ÓÎé
		BeginEvent(sceneId)
	  		AddText(sceneId,"Các hÕ phäi gia nh§p vào mµt ðµi ngû");
	  	EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return	0
	end
	
	--È¡ ði¬mÍæ¼Ò¸½½ütoÕ ðµ ¶ÓÓÑÊýÁ¿(°üÀ¨×Ô¼º)
	local	nearteammembercount = GetNearTeamCount( sceneId, selfId) 

	if	nearteammembercount<x311005_g_LimitMembers	then
		BeginEvent(sceneId)
	  		AddText(sceneId,"S¯ ngß¶i trong ðµi ngû cüa các hÕ không ðü");
	  	EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return	 0
	end
	
	if	LuaFnIsTeamLeader( sceneId, selfId)==0	then	--Ö»ÓÐ¶Ó³¤²ÅÄÜ½ÓÈÎÎñ
		BeginEvent(sceneId)
	  		AddText(sceneId,"Ngß¶i không phäi là nhóm trß·ng");
	  	EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return	 0
	end
	
	--¼ì²âÐ¡¶ÓÖÐÐúng·ñÓÐÈËÈÎÎñ¼ÇÂ¼ÒÑÂú, ¶ÓÓÑÐúng·ñÒÑ¾­½Ó¹ý´ËÈÎÎñ
	local mems = {}
	for	i=0,nearteammembercount-1 do
		mems[i] = GetNearTeamMember(sceneId, selfId, i)
		if GetMissionCount( sceneId, mems[i]) >= 20 then	--¶ÓÓÑÉíÉÏÈÎÎñÊýÁ¿Ðúng·ñ´ïµ½ÉÏÏÞ20cái
			BeginEvent(sceneId)
				AddText(sceneId,"Ghi chép nhi®m vø cüa ngß¶i trong ðµi ngû ðã ð¥y");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
			return 0
		elseif IsHaveMission(sceneId,mems[i],x311005_g_MissionId)>0 or IsHaveMission(sceneId,mems[i],4001)>0 then	
		--¶ÓÓÑÐúng·ñÒÑ¾­½Ó¹ý´ËÈÎÎñ»òÕßÁíÍâmµt cáiÈÎÎñ
			BeginEvent(sceneId)
				AddText(sceneId,"Trong ðµi ðã có ngß¶i nh§n nhi®m vø này");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
			return 0
		end
	end
	
	return	1
end

--**********************************
--Tiªp thø
--**********************************
function x311005_OnAccept( sceneId, selfId )
	
	local teamid = GetTeamId( sceneId, selfId)
	
	if( IsHaveMission(sceneId,selfId,x311005_g_MissionId) > 0)  then	--ÒÑ¾­ÓÐÈÎÎñtoÕ ðµ 
		misIndex = GetMissionIndexByID(sceneId,selfId,x311005_g_MissionId)
		copysceneid = GetMissionParam( sceneId, selfId, misIndex, 2)
		saveteamid = GetMissionParam( sceneId, selfId, misIndex, 3)
		
		if copysceneid<0 then --»¹Ã»ÓÐ½ø¹ý¸±±¾
			nearmembercount = x311005_CheckTeamLeader( sceneId, selfId )
			if nearmembercount>0 then --ÓÐ¶ÓÎé,ÈËÊý×ã¹»,Îª¶Ó³¤, Tr· v«ÖµÎªÈËÊý
			--¶Ó³¤´´½¨¸±±¾³¡¾°
				x311005_MakeCopyScene( sceneId, selfId, nearmembercount ) ;
			end
		elseif teamid==saveteamid then
			--½«×Ô¼º´«ËÍµ½¸±±¾³¡¾°
			NewWorld( sceneId, selfId, copysceneid, x311005_g_Fuben_X, x311005_g_Fuben_Z) ;
		else
			BeginEvent(sceneId)
				AddText(sceneId,"Ði«u ki®n không phù hþp");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
		end
	else
		--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁÐ±í
		if x311005_CheckAccept(sceneId,selfId) <= 0 then	--ÅÐ¶Ï½ÓÊÕÌõ¼þ
			return 0
		end

		--È¡ ði¬mÍæ¼Ò¸½½ütoÕ ðµ ¶ÓÓÑÊýÁ¿(°üÀ¨×Ô¼º)
		local	nearteammembercount = GetNearTeamCount( sceneId, selfId) 
		local mems = {}
		for	i=0,nearteammembercount-1 do
			mems[i] = GetNearTeamMember(sceneId, selfId, i)
			--¸øÃ¿cái¶ÓÎé³ÉÔ±¼ÓÈëÈÎÎñ
			AddMission( sceneId, mems[i], x311005_g_MissionId, x311005_g_ScriptId, 1, 0, 0 )
			
			misIndex = GetMissionIndexByID( sceneId, mems[i], x311005_g_MissionId )
			
			local huan = GetMissionData(sceneId,selfId,x311005_g_MissionRound)
			
			--½«ÈÎÎñtoÕ ðµ µÚ0ºÅÊý¾ÝÉèÖÃÎªÒÑ¾­Íê³ÉtoÕ ðµ 
			SetMissionByIndex(sceneId,mems[i],misIndex,0,huan)
			
			--½«ÈÎÎñtoÕ ðµ µÚ1ºÅÊý¾ÝÉèÖÃÎª0,±íÊ¾Î´Íê³ÉtoÕ ðµ ÈÎÎñ
			SetMissionByIndex(sceneId,mems[i],misIndex,1,0)
			
			--½«ÈÎÎñtoÕ ðµ µÚ2ºÅÊý¾ÝÉèÖÃÎª-1, ÓÃÓÚ±£´æ¸±±¾toÕ ðµ ³¡¾°ºÅ
			SetMissionByIndex(sceneId,mems[i],misIndex,2,-1)

			--½«ÈÎÎñtoÕ ðµ µÚ3ºÅÊý¾Ý¶ÓÎéºÅ
			SetMissionByIndex(sceneId,mems[i],misIndex,3,teamid)
		end
	end
end

--**********************************
--·ÅÆú
--**********************************
function x311005_OnAbandon( sceneId, selfId )

	misIndex = GetMissionIndexByID(sceneId,selfId,x311005_g_MissionId)
	local copyscene = GetMissionParam( sceneId, selfId, misIndex, 2)
	
	--É¾³ýÍæ¼ÒÈÎÎñÁÐ±íÖÐ¶ÔÓ¦toÕ ðµ ÈÎÎñ
    DelMission( sceneId, selfId, x311005_g_MissionId )
	
	if sceneId==copyscene then --Èç¹ûTÕi ¸±±¾ÀïÉ¾³ýÈÎÎñ,ÔòÖ±½Ó´«ËÍ»Ø
		BeginEvent(sceneId)
			AddText(sceneId,"Nhi®m vø th¤t bÕi!");
		EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		
		oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ
		
		NewWorld( sceneId, selfId, oldsceneId, 127, 28 )
	end
end

--**********************************
--´´½¨¸±±¾
--**********************************
function x311005_MakeCopyScene( sceneId, selfId, nearmembercount )

	local mems = {}
	mylevel = 0 
	for	i=0,nearmembercount-1 do
		mems[i] = GetNearTeamMember(sceneId, selfId, i)
		mylevel = mylevel+GetLevel(sceneId,mems[i])
	end
	mylevel = mylevel/nearmembercount
	
	leaderguid=LuaFnObjId2Guid(sceneId,selfId)
	LuaFnSetSceneLoad_Map(sceneId, "_pingpan_1.nav"); --µØÍ¼Ðúng±ØÐëÑ¡È¡toÕ ðµ ,¶øÇÒ±ØÐëTÕi Config/SceneInfo.iniÀïÅäÖÃºÃ
	LuaFnSetCopySceneData_TeamLeader(sceneId, leaderguid);
	LuaFnSetCopySceneData_NoUserCloseTime(sceneId, x311005_g_NoUserTime*1000);
	LuaFnSetCopySceneData_Timer(sceneId, x311005_g_TickTime*1000);
	LuaFnSetCopySceneData_Param(sceneId, 0, 999);--ÉèÖÃ¸±±¾Êý¾Ý,ÕâÀï½«0ºÅË÷ÒýtoÕ ðµ Êý¾ÝÉèÖÃÎª999,ÓÃÓÚ±íÊ¾¸±±¾ºÅ999(Êý×Ö×Ô¶¨Òå)
	LuaFnSetCopySceneData_Param(sceneId, 1, x311005_g_ScriptId);--½«1ºÅÊý¾ÝÉèÖÃÎª¸±±¾³¡¾°ÊÂ¼þ½Å±¾ºÅ
	LuaFnSetCopySceneData_Param(sceneId, 2, 0);--ÉèÖÃ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
	LuaFnSetCopySceneData_Param(sceneId, 3, -1);--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ, ³õÊ¼»¯
	LuaFnSetCopySceneData_Param(sceneId, 4, 0);--ÉèÖÃ¸±±¾¹Ø±Õ±êÖ¾, 0¿ª·Å,1¹Ø±Õ
	LuaFnSetCopySceneData_Param(sceneId, 5, 0);--ÉèÖÃÀë¿ªµ¹¼ÆÊ±´ÎÊý
	LuaFnSetCopySceneData_Param(sceneId, 6, 0);--É±ËÀtoÕ ðµ ÅÑ¾ü1toÕ ðµ ÊýÁ¿
	LuaFnSetCopySceneData_Param(sceneId, 7, 0);--É±ËÀtoÕ ðµ ÅÑ¾ü2toÕ ðµ ÊýÁ¿
	LuaFnSetCopySceneData_Param(sceneId, 8, 0);--É±ËÀtoÕ ðµ ÅÑ¾ü3toÕ ðµ ÊýÁ¿
	
	if	mylevel<=40	 then
		LuaFnSetSceneLoad_Monster(sceneId, "_pingpan_1_monster.ini")
		LuaFnSetCopySceneData_Param(sceneId, 9,536);--É±ËÀtoÕ ðµ ÅÑ¾ü1toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,10,529);--É±ËÀtoÕ ðµ ÅÑ¾ü2toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,11,538);--É±ËÀtoÕ ðµ ÅÑ¾ü3toÕ ðµ ¹ÖÎïÀàÐÍ
	elseif	mylevel<=55	 then
		LuaFnSetSceneLoad_Monster(sceneId, "_pingpan_40_monster.ini")
		LuaFnSetCopySceneData_Param(sceneId, 9,1825);--É±ËÀtoÕ ðµ ÅÑ¾ü1toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,10,1835);--É±ËÀtoÕ ðµ ÅÑ¾ü2toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,11,539);--É±ËÀtoÕ ðµ ÅÑ¾ü3toÕ ðµ ¹ÖÎïÀàÐÍ
	elseif	mylevel<=70	 then
		LuaFnSetSceneLoad_Monster(sceneId, "_pingpan_55_monster.ini")
		LuaFnSetCopySceneData_Param(sceneId, 9,1845);--É±ËÀtoÕ ðµ ÅÑ¾ü1toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,10,1850);--É±ËÀtoÕ ðµ ÅÑ¾ü2toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,11,540);--É±ËÀtoÕ ðµ ÅÑ¾ü3toÕ ðµ ¹ÖÎïÀàÐÍ
	elseif	mylevel<=85	 then
		LuaFnSetSceneLoad_Monster(sceneId, "_pingpan_70_monster.ini")
		LuaFnSetCopySceneData_Param(sceneId, 9,517);--É±ËÀtoÕ ðµ ÅÑ¾ü1toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,10,518);--É±ËÀtoÕ ðµ ÅÑ¾ü2toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,11,541);--É±ËÀtoÕ ðµ ÅÑ¾ü3toÕ ðµ ¹ÖÎïÀàÐÍ
	else
		LuaFnSetSceneLoad_Monster(sceneId, "_pingpan_85_monster.ini")
		LuaFnSetCopySceneData_Param(sceneId, 9,1955);--É±ËÀtoÕ ðµ ÅÑ¾ü1toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,10,1950);--É±ËÀtoÕ ðµ ÅÑ¾ü2toÕ ðµ ¹ÖÎïÀàÐÍ
		LuaFnSetCopySceneData_Param(sceneId,11,542);--É±ËÀtoÕ ðµ ÅÑ¾ü3toÕ ðµ ¹ÖÎïÀàÐÍ
	end	

	LuaFnSetCopySceneData_Param(sceneId,12,GetTeamId(sceneId,selfId)); --±£´æ¶ÓÎéºÅ
	
	local bRetSceneID = LuaFnCreateCopyScene(); --³õÊ¼»¯Íê³Éºóµ÷ÓÃ´´½¨¸±±¾º¯Êý
	BeginEvent(sceneId)
		if bRetSceneID>0 then
			AddText(sceneId,"D¸ch chuy¬n thành công!");
		else
			AddText(sceneId,"Xây dñng phø bän th¤t bÕi");
		end
	EndEvent(sceneId)
	DispatchMissionTips(sceneId,selfId)
	
end

--**********************************
--¼ÌÐø
--**********************************
function x311005_OnContinue( sceneId, selfId, targetId )

	misIndex = GetMissionIndexByID(sceneId,selfId,x311005_g_MissionId)
	if	GetMissionParam( sceneId, selfId, misIndex, 2)>=1	then
		DispatchMissionContinueInfo(sceneId, selfId, targetId, x311005_g_ScriptId, x311005_g_MissionId)
	end

end

--**********************************
--¼ì²âÐúng·ñ¿ÉÒÔÌá½»
--**********************************
function x311005_CheckSubmit( sceneId, selfId )
	local bRet = CallScriptFunction( SCENE_SCRIPT_ID, "CheckSubmit", sceneId, selfId, x311005_g_MissionId )
	if bRet ~= 1 then
		return 0
	end

--ÅÐ¶ÏÈÎÎñÐúng·ñÒÑ¾­Íê³É
	misIndex = GetMissionIndexByID(sceneId,selfId,x311005_g_MissionId)
	if	GetMissionParam( sceneId, selfId, misIndex, 1)>=1 then 
		return	1
	else
		return	0
	end
end

--**********************************
--Ìá½»
--**********************************
function x311005_OnSubmit( sceneId, selfId, targetId, selectRadioId )

	if x311005_CheckSubmit( sceneId, selfId, selectRadioId )>0 then		--ÒÑ¾­Hoàn t¤t nhi®m vøÁË
	
		--ÉèÖÃÈÎÎñÒÑ¾­±»Íê³É¹ý
		DelMission( sceneId,selfId,  x311005_g_MissionId )
		
		local	i=GetMissionData(sceneId,selfId,x311005_g_MissionRound)
		if	i>=10	then
			i=1
		else
			i=i+1
		end
		
		--Ìí¼ÓÈÎÎñ½±Àø
		money = 100*i+x311005_g_MoneyBonus
		AddMoney(sceneId,selfId,money );
		
		--ÉèÖÃÑ­»·ÈÎÎñtoÕ ðµ »·Êý
		SetMissionData(sceneId,selfId,x311005_g_MissionRound,i)
		
		BeginEvent(sceneId)
			strText_M = format("Ngß½i ðã ðoÕt ðßþc %d ngân lßþng",money)
	  		strText = format("Nhi®m vø bình ð¸nh phiªn loÕn ðã hoàn t¤t, hi®n gi¶ là vòng thÑ%d",i)
	  		AddText(sceneId,strText);
	  		AddText(sceneId,strText_M);
	  	EndEvent(sceneId)
	  	DispatchMissionTips(sceneId,selfId)
	end
end

--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x311005_OnKillObject( sceneId, selfId, objdataId ,objId )
	
	--È¡ ði¬mµ±Ç°³¡¾°ÀïtoÕ ðµ ÈËÊý
	num = LuaFnGetCopyScene_HumanCount(sceneId)
	
	killednumber_1 = LuaFnGetCopySceneData_Param(sceneId, 6) ;--É±ËÀÅÑ¾ütoÕ ðµ ÊýÁ¿
	killednumber_2 = LuaFnGetCopySceneData_Param(sceneId, 7) ;--É±ËÀÅÑ¾ütoÕ ðµ ÊýÁ¿
	killednumber_3 = LuaFnGetCopySceneData_Param(sceneId, 8) ;--É±ËÀÅÑ¾ütoÕ ðµ ÊýÁ¿
	killednumber = killednumber_1+killednumber_2+killednumber_3
	IsKillOK=0		
	if killednumber<20 then
		needkilled_1 = LuaFnGetCopySceneData_Param(sceneId, 9) ;--É±ËÀÅÑ¾ütoÕ ðµ ¹ÖÎïÀàÐÍ
		needkilled_2 = LuaFnGetCopySceneData_Param(sceneId,10) ;--É±ËÀÅÑ¾ütoÕ ðµ ¹ÖÎïÀàÐÍ
		needkilled_3 = LuaFnGetCopySceneData_Param(sceneId,11) ;--É±ËÀÅÑ¾ütoÕ ðµ ¹ÖÎïÀàÐÍ

		BeginEvent(sceneId)
		if objdataId==needkilled_1 then
			killednumber_1 = killednumber_1+1
			strText = format("Ðã giªt chªt quân môn v® phän bµi %d/6", killednumber_1 )
			AddText(sceneId,strText);
			IsKillOK=1
		elseif objdataId==needkilled_2 then
			killednumber_2 = killednumber_2+1
			BeginEvent(sceneId)
			strText = format("Ðã giªt chªt quân thü v® phän bµi %d/13", killednumber_2 )
			AddText(sceneId,strText);
			IsKillOK=1
		elseif objdataId==needkilled_3 then
			killednumber_3 = killednumber_3+1
			strText = format("Ðã giªt chªt quân thü lînh phän bµi %d/1", killednumber_3 )
			AddText(sceneId,strText);
			IsKillOK=1
		end
		EndEvent(sceneId)

		if IsKillOK==1 then
			for i=0,num-1 do
				humanObjId = LuaFnGetCopyScene_HumanObjId(sceneId,i)--È¡ ði¬mµ±Ç°³¡¾°ÀïÈËtoÕ ðµ objId
				DispatchMissionTips(sceneId,humanObjId)
			end
			
			LuaFnSetCopySceneData_Param(sceneId, 6, killednumber_1);--ÉèÖÃÉ±ËÀtoÕ ðµ ÅÑ¾ütoÕ ðµ ÊýÁ¿
			LuaFnSetCopySceneData_Param(sceneId, 7, killednumber_2);--ÉèÖÃÉ±ËÀtoÕ ðµ ÅÑ¾ütoÕ ðµ ÊýÁ¿
			LuaFnSetCopySceneData_Param(sceneId, 8, killednumber_3);--ÉèÖÃÉ±ËÀtoÕ ðµ ÅÑ¾ütoÕ ðµ ÊýÁ¿
		end
	end
	
	killednumber = killednumber_1+killednumber_2+killednumber_3
	if killednumber>=20 and IsKillOK==1 then
	
		--ÉèÖÃÈÎÎñÍê³É±êÖ¾
		LuaFnSetCopySceneData_Param(sceneId, 4, 1)
		
		for i=0,num-1 do
			humanObjId = LuaFnGetCopyScene_HumanObjId(sceneId,i)	--È¡ ði¬mµ±Ç°³¡¾°ÀïÈËtoÕ ðµ objId
			misIndex = GetMissionIndexByID(sceneId,humanObjId,x311005_g_MissionId)--È¡ ði¬mÈÎÎñÊý¾ÝË÷ÒýÖµ

			--½«ÈÎÎñtoÕ ðµ µÚ1ºÅÊý¾ÝÉèÖÃÎª1,±íÊ¾Íê³ÉtoÕ ðµ ÈÎÎñ
			SetMissionByIndex(sceneId,humanObjId,misIndex,1,1)--ÉèÖÃÈÎÎñÊý¾Ý

			BeginEvent(sceneId)
				strText = format("Nhi®m vø hoàn thành, sau %d giây s¨ chuy¬n t¾i v¸ trí vào cØa", x311005_g_CloseTick*x311005_g_TickTime )
				AddText(sceneId,strText);
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,humanObjId)
		end
	end
end

--**********************************
--½øÈëÇøÓòÊÂ¼þ
--**********************************
function x311005_OnEnterZone( sceneId, selfId, zoneId )
end

--**********************************
--µÀ¾ß¸Ä±ä
--**********************************
function x311005_OnItemChanged( sceneId, selfId, itemdataId )
end

--**********************************
--¸±±¾ÊÂ¼þ
--**********************************
function x311005_OnCopySceneReady( sceneId, destsceneId )

	LuaFnSetCopySceneData_Param(destsceneId, 3, sceneId);--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ
	leaderguid  = LuaFnGetCopySceneData_TeamLeader(destsceneId) ;	
	leaderObjId = LuaFnGuid2ObjId(sceneId,leaderguid);

	--È¡ ði¬mÍæ¼Ò¸½½ütoÕ ðµ ¶ÓÓÑÊýÁ¿(°üÀ¨×Ô¼º)
	local	nearteammembercount = GetNearTeamCount( sceneId, leaderObjId) 
	local mems = {}
	for	i=0,nearteammembercount-1 do
		mems[i] = GetNearTeamMember(sceneId, leaderObjId, i)
		misIndex = GetMissionIndexByID(sceneId,mems[i],x311005_g_MissionId)
		
		--½«ÈÎÎñtoÕ ðµ µÚ2ºÅÊý¾ÝÉèÖÃÎª¸±±¾toÕ ðµ ³¡¾°ºÅ
		SetMissionByIndex(sceneId,mems[i],misIndex,2,destsceneId)
				
		NewWorld( sceneId, mems[i], destsceneId, x311005_g_Fuben_X, x311005_g_Fuben_Z) ;
	end
end

--**********************************
--ÓÐÍæ¼Ò½øÈë¸±±¾ÊÂ¼þ
--**********************************
function x311005_OnPlayerEnter( sceneId, selfId )
	--ÉèÖ giâyÀÍöºó¸´»î ði¬mÎ»ÖÃ
	SetPlayerDefaultReliveInfo( sceneId, selfId, "%10", -1, "0", sceneId, x311005_g_Fuben_X, x311005_g_Fuben_Z );
end

--**********************************
--ÓÐÍæ¼ÒTÕi ¸±±¾ÖÐËÀÍöÊÂ¼þ
--**********************************
function x311005_OnHumanDie( sceneId, selfId, killerId )
end

--**********************************
--¸±±¾³¡¾°¶¨Ê±Æ÷ÊÂ¼þ
--**********************************
function x311005_OnCopySceneTimer( sceneId, nowTime )
	
	--¸±±¾Ê±ÖÓ¶ÁÈ¡¼°ÉèÖÃ
	TickCount = LuaFnGetCopySceneData_Param(sceneId, 2) ;--È¡ ði¬mÒÑ¾­Ö´ÐÐtoÕ ðµ ¶¨Ê±´ÎÊý
	TickCount = TickCount+1 ;
	LuaFnSetCopySceneData_Param(sceneId, 2, TickCount);--ÉèÖÃÐÂtoÕ ðµ ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
	
	--¸±±¾¹Ø±Õ±êÖ¾
	leaveFlag = LuaFnGetCopySceneData_Param(sceneId, 4) ;
	
	if leaveFlag == 1 then --C¥n Àë¿ª
		
		--Àë¿ªµ¹¼ÆÊ±¼ätoÕ ðµ ¶ÁÈ¡ºÍÉèÖÃ
		leaveTickCount = LuaFnGetCopySceneData_Param(sceneId, 5) ;
		leaveTickCount = leaveTickCount+1 ;
		LuaFnSetCopySceneData_Param(sceneId, 5, leaveTickCount) ;
		
		if leaveTickCount == x311005_g_CloseTick then --µ¹¼ÆÊ±¼äµ½,´ó¼Ò¶¼³öÈ¥°É
		
			oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ
			
			--½«µ±Ç°¸±±¾³¡¾°ÀïtoÕ ðµ ËùÓÐÈË´«ËÍ»ØÔ­À´½øÈëÊ±ºòtoÕ ðµ ³¡¾°
			local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
			local mems = {}
			for	i=0,membercount-1 do
				mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
				NewWorld( sceneId, mems[i], oldsceneId, 127, 28 )
			end
			
		elseif leaveTickCount<x311005_g_CloseTick then
		
			oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ

			--Í¨Öªµ±Ç°¸±±¾³¡¾°ÀïtoÕ ðµ ËùÓÐÈË,³¡¾°¹Ø±Õµ¹¼ÆÊ±¼ä
			local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
			local mems = {}
			for	i=0,membercount-1 do
				mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
	  			BeginEvent(sceneId)
	  				strText = format("Các hÕ s¨ r¶i khöi ðây sau %d giây!", (x311005_g_CloseTick-leaveTickCount)*x311005_g_TickTime )
	  				AddText(sceneId,strText);
	  			EndEvent(sceneId)
	  			DispatchMissionTips(sceneId,mems[i])
			end
		end
	elseif TickCount == x311005_g_LimitTotalHoldTime then --¸±±¾×ÜÊ±¼äÏÞÖÆµ½ÁË
		--´Ë´¦ÉèÖÃ¸±±¾ÈÎÎñÓÐÊ±¼äÏÞÖÆtoÕ ðµ Çé¿ö,µ±Ê±¼äµ½ºó´¦Àí...
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
		local mems = {}
		for	i=0,membercount-1 do
			mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
			DelMission( sceneId, mems[i], x311005_g_MissionId );--ÈÎÎñth¤t bÕi,É¾³ýÖ®

  			BeginEvent(sceneId)
  				AddText(sceneId,"Nhi®m vø th¤t bÕi, quá gi¶!");
  			EndEvent(sceneId)
  			DispatchMissionTips(sceneId,mems[i])
		end

		--ÉèÖÃ¸±±¾¹Ø±Õ±êÖ¾
		LuaFnSetCopySceneData_Param(sceneId, 4, 1) ;
		
	else
		--¶¨Ê±¼ì²é¶ÓÎé³ÉÔ±toÕ ðµ ¶ÓÎéºÅ,Èç¹û²»·ûºÏ,ÔòÌß³ö¸±±¾
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
		local mems = {}
		for	i=0,membercount-1 do
			mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
			if IsHaveMission(sceneId,mems[i],x311005_g_MissionId) > 0 then
				oldteamid = LuaFnGetCopySceneData_Param(sceneId, 12) ; --È¡ ði¬m±£´ætoÕ ðµ ¶ÓÎéºÅ
				
				if oldteamid ~= GetTeamId(sceneId,mems[i]) then
					DelMission( sceneId, mems[i], x311005_g_MissionId );--ÈÎÎñth¤t bÕi,É¾³ýÖ®

  					BeginEvent(sceneId)
  						AddText(sceneId,"Nhi®m vø th¤t bÕi, ngß½i không · trong ðúng nhóm");
  					EndEvent(sceneId)
  					DispatchMissionTips(sceneId,mems[i])
  					
 					oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ
					NewWorld( sceneId, mems[i], oldsceneId, 127, 28 )
  				end
  			end
		end
				
	end
end

