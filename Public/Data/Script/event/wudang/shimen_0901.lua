--¸±±¾ÈÎÎñ
--Ä¾ÈË

--************************************************************************
--MisDescBegin

--½Å±¾ºÅ
x223901_g_ScriptId = 223901

--¸±±¾Ãû³Æ
x223901_g_CopySceneName="Linh Tính Phong"

--ÈÎÎñºÅ
x223901_g_MissionId = 1076

--Ä¿±êNPC
x223901_g_Name = ""

--Ðúng·ñÐúngTinhÓ¢ÈÎÎñ
x223901_g_IfMissionElite = 1

--ÈÎÎñ¹éÀà
x223901_g_MissionKind = 23

--ÐÆng c¤p nhi®m vø 
x223901_g_MissionLevel = 10000

--********ÏÂÃæ¼¸ÏîÐúng¶¯Ì¬ÏÔÊ¾toÕ ðµ ÄÚÈÝ,ÓÃÓÚTÕi ÈÎÎñÁÐ±íÖÐ¶¯Ì¬ÏÔÊ¾ÈÎÎñÇé¿ö******
--Ñ­»·ÈÎÎñtoÕ ðµ Êý¾ÝË÷Òý,ÀïÃæ´æ×ÅÒÑ×ötoÕ ðµ »·Êý MD_MURENXIANG_HUAN
--g_MissionRound =
--**********************************ÒÔÉÏÐúng¶¯Ì¬****************************

--ÈÎÎñÎÄ±¾ÃèÊö
x223901_g_MissionName="Linh Tính Phong"
x223901_g_MissionInfo="#{MPFB_081023_19}"  --ÈÎÎñÃèÊö
x223901_g_MissionTarget="#{MPFB_081023_20}"	--Møc tiêu nhi®m vø
x223901_g_ContinueInfo="Các hÕ phäi tiªp tøc c¯ g¡ng nhé!"	--Î´Íê³ÉÈÎÎñtoÕ ðµ npc¶Ô»°
x223901_g_MissionComplete="Cám ½n. "	--Íê³ÉÈÎÎñnpcËµ»°toÕ ðµ »°
--ÈÎÎñC¥n É±ËÀtoÕ ðµ ¹Ö
x223901_g_Parameter_Kill_CountRandom = { { id = 1700081, numNeeded = 6, numKilled = 4 } }

--ÈÎÎñ½±Àø

--MisDescEnd
--************************************************************************

--½ÇÉ«Mission±äÁ¿Ë ði¬m÷
x223901_g_Param_huan		=0	--0ºÅ: ÒÑ¾­Íê³ÉtoÕ ðµ »·Êý,TÕi ½ÓÊÕÈÎÎñÊ±ºò¸³Öµ
x223901_g_Param_ok			=1	--1ºÅ: µ±Ç°ÈÎÎñÐúng·ñÍê³É(0Î´Íê³É£»1Íê³É)
x223901_g_Param_sceneid		=2	--2ºÅ: µ±Ç°¸±±¾ÈÎÎñtoÕ ðµ ³¡¾°ºÅ
x223901_g_Param_teamid		=3	--3ºÅ: ½Ó¸±±¾ÈÎÎñÊ±ºòtoÕ ðµ ¶ÓÎéºÅ
x223901_g_Param_killcount	=4	--4ºÅ: É±ËÀÈÎÎñ¹ÖtoÕ ðµ ÊýÁ¿
x223901_g_Param_time		=5	--5ºÅ: Íê³É¸±±¾ËùÓÃÊ±¼ä(µ¥Î»:  giây)
--6ºÅ: Î´ÓÃ
--7ºÅ: Î´ÓÃ

x223901_g_CopySceneType=FUBEN_LINGXINGFENG	--¸±±¾ÀàÐÍ,¶¨ÒåTÕi ScriptGlobal.luaÀïÃæ
x223901_g_LimitMembers=1			--¿ÉÒÔ½ø¸±±¾toÕ ðµ ×îÐ¡¶ÓÎéÈËÊý
x223901_g_TickTime=5				--»Øµ÷½Å±¾toÕ ðµ Ê±ÖÓÊ±¼ä(µ¥Î»:  giây/´Î)
x223901_g_LimitTotalHoldTime=360	--¸±±¾¿ÉÒÔ´æ»îtoÕ ðµ Ê±¼ä(µ¥Î»: ´ÎÊý),Èç¹û´ËÊ±¼äµ½ÁË,ÔòÈÎÎñ½«»áth¤t bÕi
x223901_g_LimitTimeSuccess=500		--¸±±¾Ê±¼äÏÞÖÆ(µ¥Î»: ´ÎÊý),Èç¹û´ËÊ±¼äµ½ÁË,ÈÎÎñÍê³É
x223901_g_CloseTick=6				--¸±±¾¹Ø±ÕÇ°µ¹¼ÆÊ±(µ¥Î»: ´ÎÊý)
x223901_g_NoUserTime=300			--¸±±¾ÖÐÃ»ÓÐÈËºó¿ÉÒÔ¼ÌÐø±£´ætoÕ ðµ Ê±¼ä(µ¥Î»:  giây)
x223901_g_DeadTrans=0				--ËÀÍö×ªÒÆÄ£Ê½,0: ËÀÍöºó»¹¿ÉÒÔ¼ÌÐøTÕi ¸±±¾,1: ËÀÍöºó±»Ç¿ÖÆÒÆ³ö¸±±¾
x223901_g_Fuben_X=42				--½øÈë¸±±¾toÕ ðµ Î»ÖÃX
x223901_g_Fuben_Z=46				--½øÈë¸±±¾toÕ ðµ Î»ÖÃZ
x223901_g_Back_X=59				--Ô´³¡¾°Î»ÖÃX
x223901_g_Back_Z=71					--Ô´³¡¾°Î»ÖÃZ
x223901_g_TotalNeedKill=10			--C¥n É±ËÀ¹ÖÎïÊýÁ¿

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x223901_OnDefaultEvent( sceneId, selfId, targetId )
	if( IsHaveMission(sceneId,selfId,x223901_g_MissionId) > 0)  then	--Èç¹ûÍæ¼ÒÒÑ¾­½ÓÁËCái này ÈÎÎñ
		misIndex = GetMissionIndexByID(sceneId,selfId,x223901_g_MissionId)
		bDone = x223901_CheckSubmit( sceneId, selfId )
		if bDone==0 then						--ÈÎÎñÎ´Íê³É
			BeginEvent(sceneId)
				AddText(sceneId,"Nhi®m vø th¤t bÕi, xin vÑt bö ð¬ nh§n nhi®m vø m¾i.");
			EndEvent(sceneId)
			DispatchEventList(sceneId,selfId,targetId)
		elseif bDone==1 then					--ÈÎÎñÒÑ¾­Íê³É
			BeginEvent(sceneId)
				AddText(sceneId,x223901_g_MissionName)
				AddText(sceneId,x223901_g_MissionComplete)
			EndEvent( )
			DispatchMissionDemandInfo(sceneId,selfId,targetId,x223901_g_ScriptId,x223901_g_MissionId,bDone)
		end
  elseif x223901_CheckAccept(sceneId,selfId) > 0 then		--Ã»ÓÐÈÎÎñ,Thöa mãnÈÎÎñ½ÓÊÕÌõ¼þ
		--·¢ËÍÈÎÎñTiªp thøÊ±ÏÔÊ¾toÕ ðµ ÐÅÏ¢
		BeginEvent(sceneId)
			AddText(sceneId,x223901_g_MissionName)
			AddText(sceneId,x223901_g_MissionInfo)
			AddText(sceneId,"Møc tiêu nhi®m vø: ")
			AddText(sceneId,x223901_g_MissionTarget)
		EndEvent( )
		DispatchMissionInfo(sceneId,selfId,targetId,x223901_g_ScriptId,x223901_g_MissionId)
				
  end
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x223901_OnEnumerate( sceneId, selfId, targetId )
	--Èç¹ûÒÑ½Ó´ËÈÎÎñ
	if IsHaveMission(sceneId,selfId,x223901_g_MissionId) > 0 then
		AddNumText(sceneId, x223901_g_ScriptId,x223901_g_MissionName);
	--Thöa mãnÈÎÎñ½ÓÊÕÌõ¼þ
  else
		local ret = CallScriptFunction(229000, "IsFubenMission",sceneId, selfId, targetId)
			if ret > 0 then
				AddNumText(sceneId,x223901_g_ScriptId,x223901_g_MissionName,10,0);
			end

    end
end

--**********************************
--¼ì²âTiªp thøÌõ¼þ
--**********************************
function x223901_CheckAccept( sceneId, selfId )
	if GetMissionCount( sceneId, selfId) >= 20 then	--¶ÓÓÑÉíÉÏÈÎÎñÊýÁ¿Ðúng·ñ´ïµ½ÉÏÏÞ20cái
		BeginEvent(sceneId)
			AddText(sceneId,"Nhi®m vø ghi chép cüa các hÕ ðã ð¥y.");
		EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return 0
	elseif IsHaveMission(sceneId,selfId,x223901_g_MissionId)>0 then
		--¶ÓÓÑÐúng·ñÒÑ¾­½Ó¹ý´ËÈÎÎñ»òÕßÁíÍâmµt cáiÈÎÎñ
		BeginEvent(sceneId)
			AddText(sceneId,"Các hÕ ðã nh§n ðßþc nhi®m vø này.");
		EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
		return 0
	end

	return	1
end

--**********************************
--Tiªp thø
--**********************************
function x223901_OnAccept( sceneId, selfId, targetId )
	if( IsHaveMission(sceneId,selfId,x223901_g_MissionId) > 0)  then	--ÒÑ¾­ÓÐÈÎÎñtoÕ ðµ 
		misIndex = GetMissionIndexByID(sceneId,selfId,x223901_g_MissionId)
		copysceneid = GetMissionParam( sceneId, selfId, misIndex, x223901_g_Param_sceneid)
		saveteamid = GetMissionParam( sceneId, selfId, misIndex, x223901_g_Param_teamid)
		
		if copysceneid > 0 then --½ø¹ý¸±±¾
			BeginEvent(sceneId)
				AddText(sceneId,"Nhi®m vø th¤t bÕi, xin vÑt bö ð¬ nh§n nhi®m vø m¾i.");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,selfId)
			return 0
		end
	else
		--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁÐ±í
		if x223901_CheckAccept(sceneId,selfId) <= 0 then	--ÅÐ¶Ï½ÓÊÕÌõ¼þ
			return 0
		end

		AddMission( sceneId, selfId, x223901_g_MissionId, x223901_g_ScriptId, 1, 0, 0 )

		misIndex = GetMissionIndexByID( sceneId, selfId, x223901_g_MissionId )

		--½«ÈÎÎñtoÕ ðµ µÚ1ºÅÊý¾ÝÉèÖÃÎª0,±íÊ¾Î´Íê³ÉtoÕ ðµ ÈÎÎñ
		SetMissionByIndex(sceneId,selfId,misIndex,x223901_g_Param_ok,0)

		--½«ÈÎÎñtoÕ ðµ µÚ2ºÅÊý¾ÝÉèÖÃÎª-1, ÓÃÓÚ±£´æ¸±±¾toÕ ðµ ³¡¾°ºÅ
		SetMissionByIndex(sceneId,selfId,misIndex,x223901_g_Param_sceneid,-1)

		SetMissionByIndex(sceneId, selfId,misIndex,6,10)
		
		x223901_MakeCopyScene( sceneId, selfId) ;
	end
	CallScriptFunction(229000, "SetFubenMissionSucc", sceneId, selfId, targetId)
end

--**********************************
--·ÅÆú
--**********************************
function x223901_OnAbandon( sceneId, selfId )

	misIndex = GetMissionIndexByID(sceneId,selfId,x223901_g_MissionId)
	local copyscene = GetMissionParam( sceneId, selfId, misIndex, x223901_g_Param_sceneid)

	--É¾³ýÍæ¼ÒÈÎÎñÁÐ±íÖÐ¶ÔÓ¦toÕ ðµ ÈÎÎñ
    DelMission( sceneId, selfId, x223901_g_MissionId )

	if sceneId==copyscene then --Èç¹ûTÕi ¸±±¾ÀïÉ¾³ýÈÎÎñ,ÔòÖ±½Ó´«ËÍ»Ø
		--BeginEvent(sceneId)
		--	AddText(sceneId,"ÈÎÎñth¤t bÕi!");
		--EndEvent(sceneId)
		--DispatchMissionTips(sceneId,selfId)

		oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ

		NewWorld( sceneId, selfId, oldsceneId, x223901_g_Back_X, x223901_g_Back_Z )
	end
end

--**********************************
--´´½¨¸±±¾
--**********************************
function x223901_MakeCopyScene( sceneId, selfId, nearmembercount )

	local mylevel = GetLevel(sceneId,selfId)

	leaderguid=LuaFnObjId2Guid(sceneId,selfId)
	LuaFnSetSceneLoad_Map(sceneId, "lingxingfeng.nav"); --µØÍ¼Ðúng±ØÐëÑ¡È¡toÕ ðµ ,¶øÇÒ±ØÐëTÕi Config/SceneInfo.iniÀïÅäÖÃºÃ
	LuaFnSetCopySceneData_TeamLeader(sceneId, leaderguid);
	LuaFnSetCopySceneData_NoUserCloseTime(sceneId, x223901_g_NoUserTime*1000);
	LuaFnSetCopySceneData_Timer(sceneId, x223901_g_TickTime*1000);
	LuaFnSetCopySceneData_Param(sceneId, 0, x223901_g_CopySceneType);--ÉèÖÃ¸±±¾Êý¾Ý,ÕâÀï½«0ºÅË÷ÒýtoÕ ðµ Êý¾ÝÉèÖÃÎª999,ÓÃÓÚ±íÊ¾¸±±¾ºÅ999(Êý×Ö×Ô¶¨Òå)
	LuaFnSetCopySceneData_Param(sceneId, 1, x223901_g_ScriptId);--½«1ºÅÊý¾ÝÉèÖÃÎª¸±±¾³¡¾°ÊÂ¼þ½Å±¾ºÅ
	LuaFnSetCopySceneData_Param(sceneId, 2, 0);--ÉèÖÃ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
	LuaFnSetCopySceneData_Param(sceneId, 3, -1);--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ, ³õÊ¼»¯
	LuaFnSetCopySceneData_Param(sceneId, 4, 0);--ÉèÖÃ¸±±¾¹Ø±Õ±êÖ¾, 0¿ª·Å,1¹Ø±Õ
	LuaFnSetCopySceneData_Param(sceneId, 5, 0);--ÉèÖÃÀë¿ªµ¹¼ÆÊ±´ÎÊý
	LuaFnSetCopySceneData_Param(sceneId, 6, GetTeamId(sceneId,selfId)); --±£´æ¶ÓÎéºÅ
	LuaFnSetCopySceneData_Param(sceneId, 7, 0) ;--É±ËÀBosstoÕ ðµ ÊýÁ¿

	--Nhi®m vø sß môn....È¥±ðtoÕ ðµ ÃÅÅÉtoÕ ðµ ¸±±¾ÈÎÎñ....40c¤p(º¬)ÒÔÉÏtoÕ ðµ Íæ¼ÒÊ¹ÓÃKinh nghi®m¸ßtoÕ ðµ ¹Ö....
	local isMoreExpFuben = 0
	local iniLevel
	for i, v in MENPAI_SHIMEN_MISID do
		if IsHaveMission(sceneId,selfId,v) > 0 then
			local	misIndex = GetMissionIndexByID(sceneId,selfId,v)
			local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)
			if missionType == 8 and mylevel >= 40 then
				isMoreExpFuben = 1
			end
		end
	end

  local PlayerMaxLevel = GetHumanMaxLevelLimit()
	if isMoreExpFuben == 0 then
		if mylevel < 10 then
			iniLevel = 10
		elseif mylevel < PlayerMaxLevel then
			iniLevel = floor( mylevel/10 ) * 10
		else
			iniLevel = PlayerMaxLevel
		end
		LuaFnSetSceneLoad_Monster( sceneId, "lingxingfeng_monster_" .. iniLevel .. ".ini" )
	else
		if mylevel < 50 then
			iniLevel = 40
		elseif mylevel < PlayerMaxLevel then
			iniLevel = floor( mylevel/10 ) * 10
		else
			iniLevel = PlayerMaxLevel
		end
		LuaFnSetSceneLoad_Monster( sceneId, "lingxingfeng_20monster_" .. iniLevel .. ".ini" )
	end

	LuaFnSetCopySceneData_Param(sceneId, CopyScene_LevelGap, mylevel - iniLevel) --c¤p±ð²î,CopyScene_LevelGap TÕi  scene.lua ÖÐ¸³Öµ

	local bRetSceneID = LuaFnCreateCopyScene(sceneId); --³õÊ¼»¯Íê³Éºóµ÷ÓÃ´´½¨¸±±¾º¯Êý
	BeginEvent(sceneId)
		if bRetSceneID>0 then
			AddText(sceneId,"D¸ch chuy¬n thành công!");
		else
			AddText(sceneId,"S¯ lßþng bän sao ðã ðªn gi¾i hÕn, ð« ngh¸ lát næa thØ lÕi!");
		end
	EndEvent(sceneId)
	DispatchMissionTips(sceneId,selfId)

end

--**********************************
--¼ÌÐø
--**********************************
function x223901_OnContinue( sceneId, selfId, targetId )

	misIndex = GetMissionIndexByID(sceneId,selfId,x223901_g_MissionId)
	if	GetMissionParam( sceneId, selfId, misIndex, x223901_g_Param_sceneid)>=1	then
		DispatchMissionContinueInfo(sceneId, selfId, targetId, x223901_g_ScriptId, x223901_g_MissionId)
	end

end

--**********************************
--¼ì²âÐúng·ñ¿ÉÒÔÌá½»
--**********************************
function x223901_CheckSubmit( sceneId, selfId )
	local bRet = CallScriptFunction( SCENE_SCRIPT_ID, "CheckSubmit", sceneId, selfId, x223901_g_MissionId )
	if bRet ~= 1 then
		return 0
	end

--ÅÐ¶ÏÈÎÎñÐúng·ñÒÑ¾­Íê³É
	misIndex = GetMissionIndexByID(sceneId,selfId,x223901_g_MissionId)
	if	GetMissionParam( sceneId, selfId, misIndex, x223901_g_Param_ok)>=1 then
		return	1
	else
		return	0
	end
end

--**********************************
--Ìá½»
--**********************************
function x223901_OnSubmit( sceneId, selfId, targetId, selectRadioId )
	if x223901_CheckSubmit( sceneId, selfId, selectRadioId )>0 then		--ÒÑ¾­Hoàn t¤t nhi®m vøÁË
		--ÉèÖÃÈÎÎñÒÑ¾­±»Íê³É¹ý
		DelMission( sceneId,selfId,  x223901_g_MissionId )

		CallScriptFunction(229000, "SetFubenMissionSucc", sceneId, selfId, targetId)		
		
		BeginEvent(sceneId)
			strText = "#{MPFB_081023_21}"
			AddText(sceneId,strText);
		EndEvent(sceneId)
		DispatchMissionTips(sceneId,selfId)
	end
end

--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x223901_OnKillObject( sceneId, selfId, objdataId ,objId )

	--Ðúng·ñÐúng¸±±¾
	sceneType = LuaFnGetSceneType(sceneId) ;
	if sceneType~=1 then
		return
	end
	--Ðúng·ñÐúngËùC¥n toÕ ðµ ¸±±¾
	fubentype = LuaFnGetCopySceneData_Param(sceneId,0)
	if fubentype~=x223901_g_CopySceneType then
		return
	end
	--¸±±¾¹Ø±Õ±êÖ¾
	leaveFlag = LuaFnGetCopySceneData_Param(sceneId, 4) ;
	if 	leaveFlag==1 then --Èç¹û¸±±¾ÒÑ¾­±»ÖÃ³É¹Ø±Õ×´Ì¬,ÔòÉ±¹ÖÎÞÐ§
		return
	end

	--È¡ ði¬mµ±Ç°³¡¾°ÀïtoÕ ðµ ÈËÊý
	num = LuaFnGetCopyScene_HumanCount(sceneId)

	killednumber = LuaFnGetCopySceneData_Param(sceneId, 7) ;--É±ËÀ¹ÖtoÕ ðµ ÊýÁ¿
	killednumber = killednumber+1
	LuaFnSetCopySceneData_Param(sceneId, 7, killednumber) ;--ÉèÖÃÉ±ËÀ¹ÖtoÕ ðµ ÊýÁ¿

	if killednumber<x223901_g_TotalNeedKill then

		BeginEvent(sceneId)
			strText = format("Ðã giªt chªt quái v§t:  %d/%d", killednumber, x223901_g_TotalNeedKill )
			AddText(sceneId,strText);
		EndEvent(sceneId)

		for i=0,num-1 do
			humanObjId = LuaFnGetCopyScene_HumanObjId(sceneId,i)--È¡ ði¬mµ±Ç°³¡¾°ÀïÈËtoÕ ðµ objId
			DispatchMissionTips(sceneId,humanObjId)

			misIndex = GetMissionIndexByID(sceneId,humanObjId,x223901_g_MissionId) --È¡ ði¬mÈÎÎñÊý¾ÝË÷ÒýÖµ
			local killedcount = GetMissionParam( sceneId, humanObjId, misIndex, x223901_g_Param_killcount) --È¡ ði¬mÒÑ¾­É±ÁËtoÕ ðµ ¹ÖÎïÊý
			killedcount = killedcount +1 ;
			SetMissionByIndex(sceneId,humanObjId,misIndex,x223901_g_Param_killcount,killedcount) --ÉèÖÃÈÎÎñÊý¾Ý
		end
	elseif killednumber>=x223901_g_TotalNeedKill then
		--ÉèÖÃÈÎÎñÍê³É±êÖ¾
		LuaFnSetCopySceneData_Param(sceneId, 4, 1)

		--È¡ ði¬mÒÑ¾­Ö´ÐÐtoÕ ðµ ¶¨Ê±´ÎÊý
		TickCount = LuaFnGetCopySceneData_Param(sceneId, 2) ;

		for i=0,num-1 do
			humanObjId = LuaFnGetCopyScene_HumanObjId(sceneId,i)	--È¡ ði¬mµ±Ç°³¡¾°ÀïÈËtoÕ ðµ objId
			misIndex = GetMissionIndexByID(sceneId,humanObjId,x223901_g_MissionId)--È¡ ði¬mÈÎÎñÊý¾ÝË÷ÒýÖµ

			local killedcount = GetMissionParam( sceneId, humanObjId, misIndex, x223901_g_Param_killcount) --È¡ ði¬mÒÑ¾­É±ÁËtoÕ ðµ ¹ÖÎïÊý
			killedcount = killedcount +1 ;
			SetMissionByIndex(sceneId,humanObjId,misIndex,x223901_g_Param_killcount,killedcount) --ÉèÖÃÈÎÎñÊý¾Ý

			--½«ÈÎÎñtoÕ ðµ µÚ1ºÅÊý¾ÝÉèÖÃÎª1,±íÊ¾Íê³ÉtoÕ ðµ ÈÎÎñ
			SetMissionByIndex(sceneId,humanObjId,misIndex,x223901_g_Param_ok,1)--ÉèÖÃÈÎÎñÊý¾Ý
			--Íê³É¸±±¾ËùÓÃÊ±¼ä
			SetMissionByIndex(sceneId,humanObjId,misIndex,x223901_g_Param_time,TickCount*x223901_g_TickTime)--ÉèÖÃÈÎÎñÊý¾Ý

			BeginEvent(sceneId)
				AddText(sceneId,"Nhi®m vø hoàn thành, các hÕ ðßþc chuy¬n t¾i v¸ trí vào cØa");
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,humanObjId)
			
			DelMission( sceneId, humanObjId, x223901_g_MissionId )
			--local oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ
			--NewWorld( sceneId, humanObjId, oldsceneId, x223901_g_Back_X, x223901_g_Back_Z )
			
		end
	end
end

--**********************************
--½øÈëÇøÓòÊÂ¼þ
--**********************************
function x223901_OnEnterZone( sceneId, selfId, zoneId )
end

--**********************************
--µÀ¾ß¸Ä±ä
--**********************************
function x223901_OnItemChanged( sceneId, selfId, itemdataId )
end

--**********************************
--¸±±¾ÊÂ¼þ
--**********************************
function x223901_OnCopySceneReady( sceneId, destsceneId )

	LuaFnSetCopySceneData_Param(destsceneId, 3, sceneId);--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ
	leaderguid  = LuaFnGetCopySceneData_TeamLeader(destsceneId) ;
	leaderObjId = LuaFnGuid2ObjId(sceneId,leaderguid);

	misIndex = GetMissionIndexByID(sceneId,leaderObjId,x223901_g_MissionId)

	--½«ÈÎÎñtoÕ ðµ µÚ2ºÅÊý¾ÝÉèÖÃÎª¸±±¾toÕ ðµ ³¡¾°ºÅ
	SetMissionByIndex(sceneId,leaderObjId,misIndex,x223901_g_Param_sceneid,destsceneId)

	NewWorld( sceneId, leaderObjId, destsceneId, x223901_g_Fuben_X, x223901_g_Fuben_Z) ;
end

--**********************************
--ÓÐÍæ¼Ò½øÈë¸±±¾ÊÂ¼þ
--**********************************
function x223901_OnPlayerEnter( sceneId, selfId )
	--ÉèÖ giâyÀÍöºó¸´»î ði¬mÎ»ÖÃ
	SetPlayerDefaultReliveInfo( sceneId, selfId, "%10", -1, "0", sceneId, x223901_g_Fuben_X, x223901_g_Fuben_Z );
end

--**********************************
--ÓÐÍæ¼ÒTÕi ¸±±¾ÖÐËÀÍöÊÂ¼þ
--**********************************
function x223901_OnHumanDie( sceneId, selfId, killerId )
	if x223901_g_DeadTrans==1 then --ËÀÍöºóC¥n ±»Ç¿ÖÆÌß³ö³¡¾°

		misIndex = GetMissionIndexByID(sceneId,selfId,x223901_g_MissionId)--È¡ ði¬mÈÎÎñÊý¾ÝË÷ÒýÖµ

		--½«ÈÎÎñtoÕ ðµ µÚ1ºÅÊý¾ÝÉèÖÃÎª1,±íÊ¾Íê³ÉtoÕ ðµ ÈÎÎñ
		SetMissionByIndex(sceneId,selfId,misIndex,x223901_g_Param_ok,1)--ÉèÖÃÈÎÎñÊý¾Ý
		
		--¸±±¾Ê±ÖÓ¶ÁÈ¡¼°ÉèÖÃ
		local TickCount = LuaFnGetCopySceneData_Param(sceneId, 2) ;--È¡ ði¬mÒÑ¾­Ö´ÐÐtoÕ ðµ ¶¨Ê±´ÎÊý
	
		--Íê³É¸±±¾ËùÓÃÊ±¼ä
		SetMissionByIndex(sceneId,selfId,misIndex,x223901_g_Param_time,TickCount*x223901_g_TickTime)--ÉèÖÃÈÎÎñÊý¾Ý

		oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ
		NewWorld( sceneId, selfId, oldsceneId, x223901_g_Back_X, x223901_g_Back_Z )
	end
end

--**********************************
--¸±±¾³¡¾°¶¨Ê±Æ÷ÊÂ¼þ
--**********************************
function x223901_OnCopySceneTimer( sceneId, nowTime )

	--¸±±¾Ê±ÖÓ¶ÁÈ¡¼°ÉèÖÃ
	TickCount = LuaFnGetCopySceneData_Param(sceneId, 2) ;--È¡ ði¬mÒÑ¾­Ö´ÐÐtoÕ ðµ ¶¨Ê±´ÎÊý
	TickCount = TickCount+1 ;
	LuaFnSetCopySceneData_Param(sceneId, 2, TickCount);--ÉèÖÃÐÂtoÕ ðµ ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý

	--¸±±¾¹Ø±Õ±êÖ¾
	leaveFlag = LuaFnGetCopySceneData_Param(sceneId, 4) ;

	if leaveFlag == 1 then --C¥n Àë¿ª

		--Àë¿ªµ¹¼ÆÊ±¼ätoÕ ðµ ¶ÁÈ¡ºÍÉèÖÃ
		leaveTickCount = LuaFnGetCopySceneData_Param(sceneId, 5) ;
		leaveTickCount = leaveTickCount+1 ;
		LuaFnSetCopySceneData_Param(sceneId, 5, leaveTickCount) ;

		if leaveTickCount == x223901_g_CloseTick then --µ¹¼ÆÊ±¼äµ½,´ó¼Ò¶¼³öÈ¥°É

			oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ

			--½«µ±Ç°¸±±¾³¡¾°ÀïtoÕ ðµ ËùÓÐÈË´«ËÍ»ØÔ­À´½øÈëÊ±ºòtoÕ ðµ ³¡¾°
			local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
			local mems = {}
			for	i=0,membercount-1 do
				mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
				NewWorld( sceneId, mems[i], oldsceneId, x223901_g_Back_X, x223901_g_Back_Z )
			end

		elseif leaveTickCount<x223901_g_CloseTick then

			oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3) ;--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ

			--Í¨Öªµ±Ç°¸±±¾³¡¾°ÀïtoÕ ðµ ËùÓÐÈË,³¡¾°¹Ø±Õµ¹¼ÆÊ±¼ä
			local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
			local mems = {}
			for	i=0,membercount-1 do
				mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
				if LuaFnIsObjValid(sceneId, mems[i]) == 1 and LuaFnIsCanDoScriptLogic(sceneId, mems[i]) == 1 then
	  			BeginEvent(sceneId)
	  				strText = format("Các hÕ s¨ r¶i khöi ðây sau %d giây!", (x223901_g_CloseTick-leaveTickCount)*x223901_g_TickTime )
	  				AddText(sceneId,strText);
	  			EndEvent(sceneId)
	  			DispatchMissionTips(sceneId,mems[i])
	  		end
			end
		end
	elseif TickCount == x223901_g_LimitTimeSuccess then
		--´Ë´¦ÉèÖÃÓÐÊ±¼äÏÞÖÆtoÕ ðµ ÈÎÎñÍê³É´¦Àí
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
		local mems = {}
		for	i=0,membercount-1 do
			mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
			if LuaFnIsObjValid(sceneId, mems[i]) == 1 and LuaFnIsCanDoScriptLogic(sceneId, mems[i]) == 1 then
  			BeginEvent(sceneId)
  				AddText(sceneId,"Th¶i gian hoàn t¤t nhi®m vø ðã t¾i, hoàn thành!");
  			EndEvent(sceneId)
  			DispatchMissionTips(sceneId,mems[i])
			end
			misIndex = GetMissionIndexByID(sceneId,mems[i],x223901_g_MissionId)--È¡ ði¬mÈÎÎñÊý¾ÝË÷ÒýÖµ
			--½«ÈÎÎñtoÕ ðµ µÚ1ºÅÊý¾ÝÉèÖÃÎª1,±íÊ¾Íê³ÉtoÕ ðµ ÈÎÎñ
			SetMissionByIndex(sceneId,mems[i],misIndex,x223901_g_Param_ok,1)--ÉèÖÃÈÎÎñÊý¾Ý
			--Íê³É¸±±¾ËùÓÃÊ±¼ä
			SetMissionByIndex(sceneId,mems[i],misIndex,x223901_g_Param_time,TickCount*x223901_g_TickTime)--ÉèÖÃÈÎÎñÊý¾Ý
		end

		--ÉèÖÃ¸±±¾¹Ø±Õ±êÖ¾
		LuaFnSetCopySceneData_Param(sceneId, 4, 1) ;

	elseif TickCount == x223901_g_LimitTotalHoldTime then --¸±±¾×ÜÊ±¼äÏÞÖÆµ½ÁË
		--´Ë´¦ÉèÖÃ¸±±¾ÈÎÎñÓÐÊ±¼äÏÞÖÆtoÕ ðµ Çé¿ö,µ±Ê±¼äµ½ºó´¦Àí...
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
		local mems = {}
		for	i=0,membercount-1 do
			mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
			DelMission( sceneId, mems[i], x223901_g_MissionId );--ÈÎÎñth¤t bÕi,É¾³ýÖ®
			if LuaFnIsObjValid(sceneId, mems[i]) == 1 and LuaFnIsCanDoScriptLogic(sceneId, mems[i]) == 1 then
  			BeginEvent(sceneId)
  				AddText(sceneId,"Nhi®m vø th¤t bÕi, quá gi¶!");
  			EndEvent(sceneId)
  			DispatchMissionTips(sceneId,mems[i])
  		end
		end

		--ÉèÖÃ¸±±¾¹Ø±Õ±êÖ¾
		LuaFnSetCopySceneData_Param(sceneId, 4, 1) ;

	end
end


